# 분석 구현 지침서

> 합쳐진 장부 데이터(result_*.json)를 분석하여 다차원 인사이트를 도출하는 시스템 구현 가이드

---

## 1. 데이터 소스

### 입력 파일
- 경로: `input_merged_datas/{회사명}/result_YYYY_vXX_YYYYMMDD_HHMMSS.json`
- 형식: `{ "tot": 건수, "data": [...] }`
- 각 회사별 가장 최신 타임스탬프 파일 사용

### 핵심 컬럼 (기본 큐브)

| 컬럼 | 설명 | 필수 |
|------|------|:----:|
| `데이터소스` | 분개장, 카드미반영 | ✓ |
| `손익/재무구분` | PL, BS, 카드미반영 | ✓ |
| `손익분류` | 매출, 매출원가, 판관비, 영업외수익, 영업외비용, 자본 등 | ✓ |
| `정렬순서` | 1=매출, 2=매출원가, 3=판관비, 4=영업외수익, 5=영업외비용, 10+=BS | ✓ |
| `계정과목` | 의료수입, 복리후생비 등 | ✓ |
| `계정코드` | 42000, 81101 등 | ✓ |
| `증빙유형` | 0,86,87,88,88.5,89,90 등 | ✓ |
| `전표유형구분` | 매입전표, 매출전표, 일반전표 등 | ✓ |
| `거래처명` | 거래처 이름 | ✓ |
| `거래처코드` | 거래처 코드 | ✓ |
| `월` | 01~12 | ✓ |
| `년도` | 2024 등 | ✓ |
| `순액` | 금액 (측정값) | ✓ |

### 조건부 필수 컬럼

| 조건 | 필수 컬럼 |
|------|-----------|
| 증빙유형 ∈ {86,87,89} | `유형코드`, `매입매출구분`, `사업자등록번호`, `품명` |
| 증빙유형 ∈ {86,87} | `전송일자`, `국세청승인번호` |
| 증빙유형 ∈ {88,88.5} | `전표상태`, `공제구분`, `관련거래처` |
| 증빙유형 = 88.5 | `공급가액`, `부가세`, `총금액`, `카드미반영_예측`, `AI추천_차변후보수` |
| 공제구분 = 1 | `불공제사유코드` |

### 파생 컬럼 (계산 생성)

```python
# is_vat: 피벗 열 구분용
def get_is_vat(증빙유형):
    if 증빙유형 in [86, 87, 88, 89]:
        return "vat"
    return "일반"

# 입력지연일수: 입력 품질 분석
입력지연일수 = (입력일시 - 회계일자).days

# 전자세금계산서여부
전자세금계산서여부 = "Y" if 전송일자 or 국세청승인번호 else "N"

# 요일: 패턴 분석
요일 = 회계일자.weekday()  # 0=월, 6=일

# 금액구간: 분포 분석
def get_금액구간(순액):
    abs_amt = abs(순액)
    if abs_amt < 100000: return "10만 미만"
    if abs_amt < 500000: return "10~50만"
    if abs_amt < 1000000: return "50~100만"
    if abs_amt < 5000000: return "100~500만"
    return "500만 이상"
```

---

## 2. 결과물 구조

### 2.1 기본 피벗 (필수)

**구조**: 정렬순서 → 손익분류 → 계정과목 × 데이터소스(is_vat)

```
                    분개장(vat)  분개장(일반)  분개장요약  카드미반영  총합계
1 매출
  └─ 의료수입           80.3M         -       80.3M        -      80.3M
2 매출원가
  └─ 의약품비(즉시)      5.7M         -        5.7M        -       5.7M
3 판관비               21.2M      26.4M      47.6M      6.8M     54.4M
  ├─ 복리후생비(판)      281K       166K       447K        -       447K
  ├─ 직원급여(판)          -       19.8M      19.8M        -      19.8M
  ...
```

### 2.2 거래처별 분석

**구조**: 손익분류 → 계정과목 → 거래처 × 월

```
판관비 > 복리후생비(판):
거래처              1월     2월     3월    ...   합계    비중
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
A식당              150K    160K    145K         1.8M    40%
B편의점             80K     85K     90K         1.0M    22%
C마트               50K     55K     48K         600K    13%
기타 (15개)        120K    130K    125K         1.5M    25%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
합계               400K    430K    408K         4.9M   100%
```

### 2.3 증빙유형별 분석

**구조**: 손익분류 → 계정과목 × 증빙유형

```
판관비:
계정과목          세금계산서  카드   현금영수증  수기   통장자동   합계   증빙률
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
복리후생비(판)        5%     80%      10%      5%      -      447K   95%
지급수수료(판)       60%     20%       5%     10%      5%     1.5M   85%
직원급여(판)          -       -        -       -     100%    19.8M    -
차량유지비(판)       30%     50%       5%      5%     10%     7.2M   85%
```

### 2.4 월별 추이 분석

**구조**: 손익분류 × 월

```
           1월      2월      3월     ...    12월     합계    평균    추세
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
매출       80.3M    82.1M    78.5M          85.2M   960M   80.0M   ↑
매출원가    5.7M     5.9M     5.5M           6.1M    68M    5.7M   →
판관비     47.6M    48.2M    46.8M          52.1M   570M   47.5M   ↑
영업이익   27.0M    28.0M    26.2M          27.0M   322M   26.8M   →
```

### 2.5 카드 처리 현황

**구조**: 전표상태 × 공제구분 × 계정과목

```
카드 전표 처리 현황:
                    공제                    불공제
               확정    미처리  제외     확정    미처리  제외    합계
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
복리후생비     500K     50K    10K    200K     30K     5K    795K
접대비         100K     20K     5K    300K     80K    20K    525K
차량유지비     200K     10K     -     150K     40K    10K    410K
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
처리율: 85%, 미처리 금액: 230K, 불공제 비율: 45%
```

### 2.6 카드미반영 상세

**구조**: 회계일자 × 거래처 × 금액 × 계정과목 × 업태/업종

```
카드미반영 거래 (88.5):
회계일자    거래처명           금액     공제   전표상태   계정과목   업태    업종
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
20240124   주식회사 아롬에프앤비  34,700   공제   확정제외   미추천    음식점  한식
20240121   도쿄닷지             27,800   공제   확정제외   미추천    음식점  일식
20240104   쿠마키친봉선점        11,500   공제   확정제외   미추천    음식점  분식
...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
합계: 5건, 87,500원 → 수동 계정 지정 필요
```

> **완료**: 업태/업종 데이터 포함됨 (2026-01-06)

### 2.7 이상 거래 탐지

**구조**: 계정과목 × 거래처 × 월 × 이상플래그

```
이상 거래 탐지 결과:
계정과목      거래처       월    금액     평균    Z-score  플래그
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
지급수수료   A회계사      3월   50M      12M     +3.2    금액이상
복리후생비   B식당        3월   150건    20건    +4.5    빈도이상
의약품비     C제약        3월   0        30M     -2.8    거래중단
소모품비     D사무용품    3월   -5M      3M       -      환불?
```

---

## 3. 분석 계층 구조

### 3.1 다차원 큐브 (7D)

```
기본 큐브 = groupby([
    '데이터소스',      # D1
    '손익분류',        # D2
    '계정과목',        # D3
    '증빙유형',        # D4
    '전표유형구분',    # D5
    '거래처명',        # D6
    '월'              # D7
]).agg({
    '순액': ['sum', 'count']
})
```

### 3.2 파생 분석 (슬라이스/다이스)

```python
# 기본 피벗 (2.1)
pivot_basic = cube.groupby(['정렬순서', '손익분류', '계정과목', 'is_vat']).sum()

# 거래처별 (2.2)
pivot_trade = cube.xs('판관비', level='손익분류').groupby(['계정과목', '거래처명', '월']).sum()

# 증빙유형별 (2.3)
pivot_evidence = cube.groupby(['손익분류', '계정과목', '증빙유형']).sum()

# 월별 추이 (2.4)
pivot_monthly = cube.groupby(['손익분류', '월']).sum()

# 카드 현황 (2.5)
pivot_card = cube[cube['증빙유형'].isin([88, 88.5])].groupby(['전표상태', '공제구분', '계정과목']).sum()
```

---

## 4. 구현 순서

### Phase 1: 기반 구축
```
□ 1.1 데이터 로더 구현
    - 회사별 최신 result_*.json 자동 탐색
    - JSON 파싱 및 DataFrame 변환

□ 1.2 파생 컬럼 생성
    - is_vat 계산
    - 입력지연일수 계산
    - 전자세금계산서여부 판정
    - 요일, 금액구간 추가

□ 1.3 7D 큐브 생성
    - 기본 집계 테이블 생성
    - 캐싱 (Parquet 저장)
```

### Phase 2: 기본 분석
```
□ 2.1 기본 피벗 생성 (2.1 형태)
    - 정렬순서 × 손익분류 × 계정과목 × is_vat
    - JSON + Excel 출력

□ 2.2 월별 추이 분석 (2.4)
    - 손익분류 × 월
    - 전월대비 증감률 계산
```

### Phase 3: 상세 분석
```
□ 3.1 거래처별 분석 (2.2)
    - 손익분류 × 계정과목 × 거래처 × 월
    - TOP N 거래처 + 기타 그룹화
    - 집중도(HHI) 계산

□ 3.2 증빙유형별 분석 (2.3)
    - 손익분류 × 계정과목 × 증빙유형
    - 증빙률 계산 (증빙있음 / 전체)
```

### Phase 4: 카드/세금 분석
```
□ 4.1 카드 처리 현황 (2.5)
    - 전표상태 × 공제구분 × 계정과목
    - 미처리 건/금액 집계

□ 4.2 카드미반영 상세 (2.6)
    - 88.5 증빙유형 필터링
    - 수동 처리 필요 목록

□ 4.3 불공제 분석
    - 불공제사유코드별 집계
    - 개선 가능 불공제 식별
```

### Phase 5: 고급 분석
```
□ 5.1 이상 거래 탐지 (2.7)
    - Z-score 계산
    - 전월대비 급변 탐지
    - 빈도 이상 탐지

□ 5.2 입력 품질 분석
    - 입력지연일수 분포
    - 증빙유형별 지연 패턴
```

### Phase 6: 출력 및 시각화
```
□ 6.1 Excel 출력
    - 다중 시트 워크북
    - 피벗 테이블 스타일링

□ 6.2 JSON 출력
    - 계층적 구조
    - API 호환 형식

□ 6.3 HTML 대시보드 (추후)
    - Plotly/Streamlit
    - 인터랙티브 필터
```

---

## 5. 출력 파일 구조

### 5.1 Excel 출력 (분석결과.xlsx)

| 시트명 | 내용 |
|--------|------|
| 원본데이터 | result 원본 전체 |
| 기본피벗 | 정렬순서 × 손익분류 × 계정과목 × 소스유형 |
| 월별추이 | 손익분류 × 월 + 합계/평균 |
| 계정월별 | 계정과목별 월별 상세 |
| 거래처TOP | 계정과목별 거래처 TOP 10 |
| 증빙유형별 | 계정과목 × 증빙유형 비율 + 증빙률 |
| 카드현황 | 전표상태 × 공제구분 |
| 카드미반영 | 미처리 거래 상세 (업태/업종 포함) |
| 요일별 | 요일별 거래 패턴 |
| 금액구간별 | 금액대별 분포 |
| 이상거래 | Z-score/급변/마이너스 탐지 |

#### Excel 서식

- **열너비**: 자동 조정 (한글 너비 고려)
- **금액 형식**: `#,##0` (천단위 콤마)

### 5.2 JSON 출력 (요약.json)

```json
{
  "meta": {
    "회사명": "더제이의원",
    "기간": "2024-01",
    "생성일시": "2026-01-05T12:00:00"
  },
  "기본피벗": {
    "1_매출": {
      "의료수입": {"vat": 80322456, "일반": 0, "합계": 80322456}
    },
    "3_판관비": {
      "복리후생비(판)": {"vat": 280554, "일반": 166300, "합계": 446854}
    }
  },
  "거래처별": { ... },
  "월별추이": { ... },
  "카드현황": { ... },
  "이상거래": [ ... ]
}
```

---

## 6. 기술 스택

```
Python 3.11+
├── pandas          # 데이터 처리
├── openpyxl        # Excel 출력
├── json            # JSON 입출력
└── (선택)
    ├── polars      # 대용량 처리 시
    ├── plotly      # 시각화
    └── streamlit   # 대시보드
```

---

## 7. 디렉토리 구조 (예정)

```
analyze_merged_data/
├── input_merged_datas/     # 입력 데이터 (회사별)
├── output/                 # 출력 결과
│   └── {회사명}/
│       ├── 요약.xlsx
│       └── 요약.json
├── src/                    # 소스 코드
│   ├── loader.py          # 데이터 로더
│   ├── transform.py       # 파생 컬럼 생성
│   ├── cube.py            # 7D 큐브 생성
│   ├── analysis/          # 분석 모듈
│   │   ├── basic_pivot.py
│   │   ├── trade_analysis.py
│   │   ├── evidence_analysis.py
│   │   ├── card_analysis.py
│   │   └── anomaly_detection.py
│   └── export/            # 출력 모듈
│       ├── excel_export.py
│       └── json_export.py
├── CLAUDE.md
├── IMPLEMENTATION_GUIDE.md  # 이 문서
└── pyproject.toml
```

---

## 8. 주의사항

1. `new_docs/` 폴더는 참고용으로만 사용, 수정/삭제 금지
2. 증빙유형 88.5는 카드미반영 예측으로 별도 처리
3. 정렬순서가 큰 틀(PL 1~5, BS 10+, 카드미반영 99)
4. 거래처 분석 시 "기타" 그룹화 필요 (TOP N 외)
5. 금액은 항상 `순액` 기준 (차변-대변 이미 계산됨)
