# 병합지침서

> 분개장 + 매입매출전표 + 신용카드자동전표 전체 컬럼 병합

---

## 1. 목적

분개장을 기준으로 매입매출전표/신용카드 정보를 오른쪽에 붙여서
일자별 손익 상세 내역을 한눈에 볼 수 있게 함.

**활용:**
- 분개장 라인별로 원본 증빙(매입매출/카드) 확인
- 신용카드 미반영 건 파악
- 손익계산서 순서로 정렬된 일자별 상세

---

## 2. 참조 문서

| 문서 | 활용 내용 |
|------|-----------|
| `COLUMN_SPEC.md` | 분개장/매입매출/신용카드 컬럼 정의 확인 |
| `CODE_REFERENCE.md` | key_gr(손익분류), ty_jungstat(전표상태), ty_mth2(매입매출유형) 코드값 |
| `LOGIC_RULES.md` | P/L 계정 필터링 기준 (key_gr 14~21) |

---

## 3. 데이터 소스

### 3.1 분개장 (`COLUMN_SPEC.md` 1절 참조)

**베이스 데이터** - 모든 확정된 분개

핵심 컬럼:
- `da_date`: 회계일자 (YYYYMMDD)
- `cd_acctit`: 계정코드
- `nm_acctit`: 계정과목
- `mn_bungae1`: 차변금액
- `mn_bungae2`: 대변금액
- `순액`: 손익분류별 순액 (계산 컬럼, 4.5절 참조)
- `nm_trade`: 거래처명
- `no_exter2`: 증빙유형 → `CODE_REFERENCE.md` 1절

### 3.2 매입매출전표 (`COLUMN_SPEC.md` 2절 참조)

**매칭 대상** - 세금계산서/카드 매입매출 상세

핵심 컬럼:
- `da_date`: 거래일자
- `nm_trade`: 거래처명
- `mn_sum`: 합계금액 (매칭 키)
- `no_bisocial`: 사업자등록번호
- `mn_mnam`: 공급가액
- `mn_vat`: 부가세
- `ty_mth2`: 유형코드 → `CODE_REFERENCE.md` 3절

### 3.3 신용카드 자동전표 (`COLUMN_SPEC.md` 3절 참조)

**매칭 대상** + **미반영 건 포함**

핵심 컬럼:
- `da_sbook`: 거래일자
- `nm_trade`: 거래처명
- `mn_total`: 총금액 (매칭 키)
- `ty_jungstat`: 전표상태 → `CODE_REFERENCE.md` 2절
  - 2=전표확정 (분개장에 있음)
  - 그 외=미반영 (분개장에 없음)
- `ty_gongjea`: 공제구분 → `CODE_REFERENCE.md` 5절
- `bisocial_no`: 사업자번호

---

## 4. 병합 로직

### 4.0 전처리 (`LOGIC_RULES.md` 1절 참조)

분개장 처리 전 제외할 전표:

| 제외 코드 | 설명 | 비고 |
|:---------:|------|------|
| no_exter2 = 7 | 잉여금관련전표 | 법인에만 존재 |
| no_exter2 = 27 | 손익대체분개 | 개인에만 존재 |

```
회사유형 무관하게 7, 27 둘 다 제외 (상호 배타적으로 존재)
```

### 4.1 P/L 계정 필터링 (`LOGIC_RULES.md` 참조)

분개장에서 손익계산서 계정만 추출:

```
key_gr ∈ {14, 19, 20, 21}  # immediate 방식: 15~18 제외
```

| key_gr | 분류 | 비고 |
|:------:|------|------|
| 14 | 매출 | |
| ~~15~18~~ | ~~매출원가~~ | **immediate 방식에서 제외** (4.1.1로 대체) |
| 19 | 판관비 | |
| 20 | 영업외수익 | |
| 21 | 영업외비용 | |

**참조:** `phase1/analysis/preprocessor.py` 253-262줄

### 4.1.1 즉시원가 인식 및 매출원가 변환

재고자산 계정을 **매출원가 계정으로 변환**하여 손익계산서 형태로 표시.

**구현 코드:** `new_code/daily_journal.py`
- 함수: `load_account_master()` - 재고→원가 매핑 로드
- 함수: `merge_all_columns()` - 계정 변환 로직 (308-320줄)

---

#### 대상 계정 (INVENTORY_PREFIXES)

```python
# daily_journal.py 48-53줄
INVENTORY_PREFIXES = (
    '146', '147', '148', '149',  # 상품 관련
    '150', '151', '152', ...,    # 제품/원재료
    '162', '163', ...,           # 부재료/저장품/재공품
    '170', '171', '172',         # 미완성공사/소모품
)
```

---

#### 제외 조건

```
no_exter2 = 5 (결산분개) + 대변 > 0 → 원가대체 분개이므로 제외
```

---

#### 재고자산 → 매출원가 변환 규칙

계정과목 마스터(`guide/계정과목및적요등록.json`)의 `key_acctit2_v` 필드 참조:

| 재고자산 | 매출원가 (결산) | 매출원가 (즉시) | 비고 |
|:--------:|:--------------:|:--------------:|------|
| 146 상품 | 45100 | **45101** | 끝자리 1 = 즉시 |
| 150 제품 | 45500 | **45501** | |
| 152 완성건물 | 45300 | **45301** | |
| 153 원재료 | 45400 | **45401** | |

**코드:**
```python
# daily_journal.py 308-320줄
if is_immediate_cost:
    cd_prefix = cd_acctit[:3]
    # 매출원가 계정으로 변환 (146 → 45101)
    base_cogs = inventory_to_cogs.get(cd_prefix, f'{cd_prefix}00')
    cogs_cd = base_cogs[:4] + '1'  # 45100 → 45101

    result['cd_acctit'] = cogs_cd
    result['nm_acctit'] = f"{orig_nm}(즉시)"  # 원래 계정명 + (즉시)
    result['_원본계정'] = cd_acctit           # 원본 보존
    result['_손익분류'] = '매출원가'
```

---

#### 출력 예시

| cd_acctit | nm_acctit | _원본계정 | _손익분류 |
|:---------:|-----------|:---------:|:---------:|
| 45101 | 의약품비(즉시) | 14600 | 매출원가 |
| 45501 | 제품(즉시) | 15000 | 매출원가 |

---

#### 목적

- **월별 원가 분석**: 어디서, 언제, 얼마에 샀는지 파악
- **손익계산서 형태 통일**: 146이 아닌 451로 표시
- **결산분개와 구분**: 45100(결산) vs 45101(즉시)

### 4.2 매칭 키

```
매칭 키 = (일자, 거래처명, 금액)
```

**분개장 → 매입매출전표:**
```
분개장: (da_date, nm_trade, mn_bungae1 or mn_bungae2)
매입매출: (da_date, nm_trade, mn_sum)
```

**분개장 → 신용카드:**
```
분개장: (da_date, nm_trade, mn_bungae1 or mn_bungae2)
신용카드: (da_sbook, nm_trade, mn_total)
```

### 4.3 컬럼 병합

```
[분개장 컬럼들] + [SP_매입매출 컬럼들] + [CARD_신용카드 컬럼들]
```

- 매칭되면 해당 컬럼에 값 있음
- 매칭 안 되면 빈값

### 4.4 신용카드 미반영 추가

```
조건: ty_jungstat ≠ 2
```

- 분개장에 없는 카드 사용 내역
- 분개장/매입매출 컬럼은 빈값
- CARD_ 컬럼에만 값 있음
- `_소스 = '카드미반영'`

### 4.5 순액 계산 (`LOGIC_RULES.md` 4절 참조)

손익분류에 따라 순액 계산 방식이 다름:

| 손익분류 | key_gr | 계산 | 의미 |
|----------|:------:|------|------|
| 매출 | 14 | 대변 - 차변 | 수익성 |
| 영업외수익 | 20 | 대변 - 차변 | 수익성 |
| 매출원가 | 15~18 | 차변 - 대변 | 비용성 |
| 판관비 | 19 | 차변 - 대변 | 비용성 |
| 영업외비용 | 21 | 차변 - 대변 | 비용성 |

```
수익성 계정: 순액 = mn_bungae2 - mn_bungae1
비용성 계정: 순액 = mn_bungae1 - mn_bungae2
```

- 양수 = 정상 거래
- 음수 = 환입/취소

---

## 5. 출력 구조

### 5.1 컬럼 순서

| 순서 | Prefix | 내용 |
|:----:|--------|------|
| 1 | `_` | 메타 (_손익분류, _정렬순서, _소스) |
| 2 | (없음) | 분개장 원본 컬럼 |
| 3 | `SP_` | 매입매출전표 컬럼 |
| 4 | `CARD_` | 신용카드 컬럼 |

**순액 컬럼 위치:**
```
... → mn_bungae1 → mn_bungae2 → 순액 → ...
```

### 5.2 정렬

```
1차: _정렬순서 (손익계산서 순서)
2차: da_date (일자)
```

### 5.3 시트 구성

| 시트 | 필터 | 비고 |
|------|------|------|
| 전체 | 모든 데이터 | |
| 매출 | _손익분류 = '매출' | key_gr=14 |
| 매출원가 | _손익분류 = '매출원가' | 재고자산→45101 변환 |
| 판관비 | _손익분류 = '판관비' | key_gr=19 |
| 영업외수익 | _손익분류 = '영업외수익' | key_gr=20 |
| 영업외비용 | _손익분류 = '영업외비용' | key_gr=21 |
| 카드미반영 | _손익분류 = '카드미반영' | ty_jungstat≠2 |

**참고:**
- 매출원가(45101): 재고자산 매입을 즉시 원가로 변환
- 결산분개(45100): key_gr 15~18은 제외 (중복 방지)

---

## 6. 실행

```bash
uv run python new_code/daily_journal.py thej 2024
uv run python new_code/daily_journal.py corp 2024
```

**출력:** `output/{company}/일자별_손익상세_{year}.xlsx`

---

## 7. 주의사항

### 매칭률이 낮을 때

매칭 키(일자+거래처+금액)가 정확히 일치해야 매칭됨.

확인할 점:
- 거래처명 불일치 (분개장 vs 매입매출/카드)
- 금액 불일치 (공급가액 vs 합계금액)
- 일자 불일치

### 카드 미반영 건

`ty_jungstat ≠ 2`인 건들:
- 1=확정가능: 아직 전표 생성 안 함
- 3=확정제외: 수동 제외
- 4=중복: 중복 감지
- 5=미추천: AI 추천 불가

→ `CODE_REFERENCE.md` 2절 참조
