# 처리 규칙 (Business Logic)

## 0. 처리 순서 (핵심!)

```
STEP 1: 전처리 (최우선)
├── 1-1. 손익대체(27) / 잉여금(7) 제외
└── 1-2. 결산분개 재고대변 제외

STEP 2: 원가화 (재고자산 → 매출원가)
└── 재고자산(14x~17x) → 즉시 매출원가

STEP 3: 분류 (PL vs BS)
├── 원가화된 재고 → PL
├── key_gr 14~21 → PL
└── key_gr 1,3~13 → BS (재고자산 제외!)
```

**구현:** `new_code/daily_journal.py` (307-341줄)

---

## 1. 전처리 규칙

### 제외할 전표

| 제외 코드 | 설명 | 비고 |
|-----------|------|------|
| `no_exter2 = 7` | 잉여금관련전표 | 법인에만 존재 |
| `no_exter2 = 27` | 손익대체분개 | 개인에만 존재 |
| `no_exter2 = 5` (재고대변) | 결산분개 중 재고→원가 대체 | 공통 |

> **Note**: 7과 27은 회사유형 무관하게 둘 다 제외 (상호 배타적으로 존재)

---

## 2. PL vs BS 분류

### PL_vs_BS 컬럼

| 값 | 설명 | key_gr |
|----|------|--------|
| PL | 손익계산서 | 14~21 + 즉시원가 |
| BS | 재무상태표 | 1, 3~13 |
| 카드미반영 | 분개 없음 | - |

### KEY_GR_PL (손익계산서)

| key_gr | 분류 | 정렬 |
|:------:|------|:----:|
| 14 | 매출 | 1 |
| (즉시원가) | 매출원가 | 2 |
| 19 | 판관비 | 3 |
| 20 | 영업외수익 | 4 |
| 21 | 영업외비용 | 5 |

### KEY_GR_BS (재무상태표)

| key_gr | 분류 | 비고 |
|:------:|------|------|
| 1 | 유동자산 | 현금, 예금, 외상매출금 |
| ~~2~~ | ~~재고자산~~ | **제외! 원가화로 PL 처리** |
| 3 | 기타유동자산 | 선급금, 선급비용 |
| 4 | 비유동자산-투자 | 장기투자증권 |
| 5 | 비유동자산-유형 | 건물, 차량운반구 |
| 6 | 비유동자산-기타 | 임차보증금, 전세권 |
| 7 | 유동부채 | 미지급금, 예수금 |
| 8 | 비유동부채 | 장기차입금 |
| 9~12 | 자본 | 자본금, 이익잉여금 |
| 13 | 기타포괄손익 | |

---

## 3. 재고자산 처리 방식

| 방식 | 설명 | 월별 손익 | 연간 손익 |
|------|------|:--------:|:--------:|
| **immediate (기본)** | 매입(14x) 즉시 원가 인식 | 정확 | 재고차이 |
| closing | 결산분개(45x) 그대로 | 12월 집중 | 정확 |

**본 프로젝트 기본**: immediate

### 재고자산 → 매출원가 매핑

| 재고자산 | 매출원가(결산) | 매출원가(즉시) | 비고 |
|:--------:|:-------------:|:-------------:|------|
| 146 상품 | 45100 | **45101** | 끝자리 1 = 즉시 |
| 150 제품 | 45500 | **45501** | |
| 152 완성건물 | 45300 | **45301** | |
| 153 원재료 | 45400 | **45401** | |

### 대상 계정 코드

```python
INVENTORY_PREFIXES = (
    '146', '147', '148', '149',  # 상품
    '150', '151', '152', '153', '154', '155', '156', '157', '158', '159',  # 제품/원재료
    '162', '163', '164', '165', '166', '167', '168', '169',  # 부재료/저장품
    '170', '171', '172',  # 미완성공사/소모품
)
```

### 제외 조건

```
결산분개(no_exter2=5) + 대변 > 0 → 원가대체 분개이므로 제외
```

---

## 4. 전표 카운트 기준

```
❌ 분개 줄 수
✅ 전표 건수 (da_date + no_acct 조합)
```

**예시**: 카드 결제 1건
```
(차) 소모품비  100,000
(대) 미지급금  100,000
→ 2줄이지만 1건으로 카운트
```

---

## 5. 손익 계산 공식

### 연간 검증 (손익계산서 vs 분개장)

| 항목 | 분개장 계산 | 허용 오차 |
|------|-------------|-----------|
| 매출액 | 4xx 대변 - 차변 (451~455 제외) | 100원 |
| 매출원가 | 451~455 차변 - 대변 | **재고차이 허용** |
| 판관비 | 8xx 차변 - 대변 | 100원 |
| 영업외수익 | **key_gr=20** 대변 - 차변 | 100원 |
| 영업외비용 | **key_gr=21** 차변 - 대변 | 100원 |

### 월별 분석 (immediate 방식)

| 항목 | 분개장 계산 |
|------|-------------|
| 매출액 | 4xx 대변 - 차변 (451~455 제외) |
| **매출원가** | **14x 차변 (매입 즉시 원가)** |
| 판관비 | 8xx 차변 - 대변 |
| 영업외수익 | key_gr=20 대변 - 차변 |
| 영업외비용 | key_gr=21 차변 - 대변 |

---

## 6. 영업외손익 분류 (핵심!)

```
❌ 9xx 코드 기준
✅ key_gr 기준
```

| key_gr | 분류 | 예시 |
|:------:|------|------|
| 20 | 영업외수익 | 이자수익, 잡이익 |
| 21 | 영업외비용 | 이자비용, 기부금 |

**주의**: 9xx 코드라도 key_gr이 다르면 영업외손익 아님!
- `96200` 임차보증금 → key_gr=6 → B/S 자산
- `99800` 법인세등 → key_gr=23 → 별도 항목

---

## 7. 전표구분 클러스터링

### 전표구분 판단

```python
if no_acct >= 50000:
    전표구분 = "매입매출"
else:
    전표구분 = "일반"
```

### 클러스터 생성

```
클러스터 = {no_exter2}_{전표구분}

예시:
- 88_매입매출  → 신용카드 + 매입매출전표
- 88_일반      → 신용카드 + 일반전표
- 86_매입매출  → 세금계산서 + 매입매출전표
```

**활용**: 같은 증빙유형(88)이라도 공제 여부가 다름

---

## 8. 신용카드 미반영 처리

### 전표상태별 처리

| ty_jungstat | 상태 | 분개장 반영 | 분석 포함 |
|:-----------:|------|:----------:|:---------:|
| 1 | 확정가능 | X | O |
| 2 | 전표확정 | O | 이미 포함 |
| 3 | 확정제외 | X | O |
| 4 | 중복전표 | X | O |
| 5 | 미추천 | X | O |
| 6 | 삭제전표 | X | X |

### 증빙유형 자동 채우기

카드미반영 예측 시, 전표유형구분(nm_yuh)과 증빙유형(no_exter2)이 모두 공란이면:

```
no_exter2 = 88.5  (카드미반영 예측)
```

> 88.5는 88(신용카드)과 구분하기 위한 시스템 생성 코드

---

## 9. 재고 검증 공식

```
당기 매입 (14x 차변)         = A
매출원가 대체 (14x 대변)     = B
기말재고 증가                 = A - B

검증: 매입 - 재고증가 = 손익계산서 매출원가
```
