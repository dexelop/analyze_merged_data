# 03. 거래처별 분석

## 개요

계정과목별 주요 거래처 파악 및 집중도 분석

---

## 대상 데이터

- **범위**: 판관비 (손익분류 == '판관비')
- **이유**: 비용 통제 및 거래처 관리 목적

---

## 분석 유형

### 3.1 거래처별 월별 집계

```python
df_pangwan = df[df['손익분류'] == '판관비'].copy()

trade_analysis = df_pangwan.groupby(['계정과목', '거래처명', '월']).agg({
    '순액': ['sum', 'count']
}).reset_index()

trade_analysis.columns = ['계정과목', '거래처명', '월', '금액', '건수']
```

---

### 3.2 계정과목별 거래처 TOP 10

```python
# 거래처별 합계
trade_top = df_pangwan.groupby(['계정과목', '거래처명'])['순액'].sum().reset_index()

# 계정과목별 내림차순 정렬
trade_top = trade_top.sort_values(['계정과목', '순액'], ascending=[True, False])

# 계정과목별 TOP 10 추출 (rank 사용)
trade_top['rank'] = trade_top.groupby('계정과목')['순액'].rank(
    method='first',
    ascending=False
)
trade_top10 = trade_top[trade_top['rank'] <= 10].drop(columns=['rank'])
```

---

## 목표 결과물

```
계정과목          거래처명              순액      비중
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
복리후생비(판)
                  A식당               1,800,000   40%
                  B편의점             1,000,000   22%
                  C마트                 600,000   13%
                  ...
지급수수료(판)
                  D회계법인           5,000,000   35%
                  E법무법인           3,000,000   21%
                  ...
```

---

## 추가 분석 (선택)

### 집중도 지수 (HHI)

```python
def calculate_hhi(group):
    """
    Herfindahl-Hirschman Index
    - 0~1 범위 (1에 가까울수록 집중)
    - 0.25 이상: 높은 집중도
    """
    total = group['순액'].sum()
    if total == 0:
        return 0
    shares = group['순액'] / total
    return (shares ** 2).sum()

hhi_by_account = trade_top.groupby('계정과목').apply(calculate_hhi)
```

### 거래처 변동 분석

```python
# 월별 신규/이탈 거래처
def analyze_trade_changes(df, prev_month, curr_month):
    prev_traders = set(df[df['월'] == prev_month]['거래처명'])
    curr_traders = set(df[df['월'] == curr_month]['거래처명'])

    new_traders = curr_traders - prev_traders      # 신규
    lost_traders = prev_traders - curr_traders     # 이탈

    return new_traders, lost_traders
```

---

## 출력 형식

### Excel (거래처TOP 시트)

```
계정과목 | 거래처명 | 순액
```

### JSON

```json
{
  "거래처TOP": [
    {
      "계정과목": "복리후생비(판)",
      "거래처명": "A식당",
      "순액": 1800000
    },
    ...
  ]
}
```

---

## 주의사항

1. **판관비 한정**: 전체 데이터가 아닌 판관비만 분석
2. **TOP N 제한**: 계정과목당 10개로 제한 (출력 가독성)
3. **기타 그룹화**: 필요시 TOP N 외 거래처는 "기타"로 묶기
