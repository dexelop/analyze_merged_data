# 10. 회계 데이터 인사이트 차트 지침서

## 개요

회계 데이터를 시각화하여 인사이트를 도출하는 30개 차트에 대한 상세 지침서입니다.

**스크립트:** `src/create_charts.py`
**출력 위치:** `output/{회사명}/charts_{timestamp}/`

---

## 공통 설정

### 한글 폰트
```python
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False
```

### 금액 포맷터
```python
def format_krw(value):
    if abs(value) >= 1e8:
        return f'{value/1e8:.1f}억'
    elif abs(value) >= 1e4:
        return f'{value/1e4:.0f}만'
    else:
        return f'{value:,.0f}'
```

### 컬러 팔레트

| 구분 | 색상 코드 | 용도 |
|------|-----------|------|
| primary | #2E86AB | 매출, 기본 강조 |
| secondary | #A23B72 | 매출원가 |
| warning | #F18F01 | 판관비, 카드 |
| success | #28A745 | 이익, 공제 |
| danger | #C73E1D | 손실, 불공제 |

---

## 1. 수익/비용 분석 (5개)

### 01. 손익분류별 총액

| 항목 | 내용 |
|------|------|
| **목표** | 손익분류(매출, 매출원가, 판관비 등)별 총 금액을 한눈에 파악 |
| **차트 유형** | 가로 막대 그래프 (Horizontal Bar) |
| **인사이트** | 전체 손익 구조 파악, 비용 항목 중 가장 큰 부분 식별 |

**인풋 데이터:**
```python
# 컬럼: 손익분류, 순액
df.groupby('손익분류')['순액'].sum()
```

**계산식:**
```python
data = df.groupby('손익분류')['순액'].sum().sort_values(ascending=True)
# 결과: {'매출': 1,016,553,997, '판관비': 944,601,172, ...}
```

---

### 02. 매출 vs 원가 vs 판관비 비교

| 항목 | 내용 |
|------|------|
| **목표** | 매출과 주요 비용 항목을 비교하여 수익성 분석 |
| **차트 유형** | 세로 막대 그래프 + 기준선 (매출총이익, 영업이익) |
| **인사이트** | 매출총이익률, 영업이익률 직관적 파악 |

**인풋 데이터:**
```python
# 손익분류 = '매출', '매출원가', '판관비'
revenue = df[df['손익분류'] == '매출']['순액'].sum()
cost = df[df['손익분류'] == '매출원가']['순액'].sum()
expense = df[df['손익분류'] == '판관비']['순액'].sum()
```

**계산식:**
```python
매출총이익 = revenue - cost
영업이익 = 매출총이익 - expense
매출총이익률 = (매출총이익 / revenue) * 100
영업이익률 = (영업이익 / revenue) * 100
```

---

### 03. 판관비 구성 (도넛 차트)

| 항목 | 내용 |
|------|------|
| **목표** | 판관비 내 계정과목별 비중 파악 |
| **차트 유형** | 도넛 차트 (Donut/Pie) |
| **인사이트** | 비용 절감 우선순위 항목 식별 |

**인풋 데이터:**
```python
# 손익분류 = '판관비'인 데이터의 계정과목별 순액 합계
expense_df = df[df['손익분류'] == '판관비']
data = expense_df.groupby('계정과목')['순액'].sum()
```

**계산식:**
```python
# 상위 10개 + 기타로 집계
top10 = data.sort_values(ascending=False).head(10)
others = data.sort_values(ascending=False)[10:].sum()
top10['기타'] = others

# 비율 계산
비율 = (각 항목 금액 / 전체 판관비 합계) * 100
```

---

### 04. 매출원가 항목별

| 항목 | 내용 |
|------|------|
| **목표** | 매출원가 구성 항목 분석 |
| **차트 유형** | 가로 막대 그래프 |
| **인사이트** | 원가 구조 파악, 원가 절감 포인트 식별 |

**인풋 데이터:**
```python
cost_df = df[df['손익분류'] == '매출원가']
data = cost_df.groupby('계정과목')['순액'].sum()
```

**계산식:**
```python
data = data.sort_values(ascending=False)
# 내림차순 정렬하여 가장 큰 원가 항목부터 표시
```

---

### 05. 월별 이익률 추이

| 항목 | 내용 |
|------|------|
| **목표** | 월별 매출총이익률과 영업이익률 변화 추적 |
| **차트 유형** | 라인 차트 (2개 라인) |
| **인사이트** | 계절성 파악, 이익률 악화/개선 시점 식별 |

**인풋 데이터:**
```python
monthly = df.groupby(['월', '손익분류'])['순액'].sum().unstack(fill_value=0)
# 컬럼: 매출, 매출원가, 판관비
```

**계산식:**
```python
for each 월 in 1~12:
    매출총이익률[월] = ((매출[월] - 매출원가[월]) / 매출[월]) * 100
    영업이익률[월] = ((매출[월] - 매출원가[월] - 판관비[월]) / 매출[월]) * 100
```

---

## 2. 월별 추이 분석 (5개)

### 06. 월별 매출/원가/판관비 추이

| 항목 | 내용 |
|------|------|
| **목표** | 월별 주요 손익 항목의 변동 추이 파악 |
| **차트 유형** | 그룹 막대 그래프 (Grouped Bar) |
| **인사이트** | 계절성, 비용 증가 시점 파악 |

**인풋 데이터:**
```python
monthly = df.groupby(['월', '손익분류'])['순액'].sum().unstack(fill_value=0)
# index: 월 (1~12)
# columns: 매출, 매출원가, 판관비
```

**계산식:**
```python
# 각 월별로 손익분류별 순액 합계
# 막대 위치: x - width, x, x + width (3개 그룹)
```

---

### 07. 월별 매출 구성

| 항목 | 내용 |
|------|------|
| **목표** | 월별 매출을 계정과목별로 분해하여 구성 파악 |
| **차트 유형** | 스택 막대 그래프 (Stacked Bar) |
| **인사이트** | 매출원별 기여도 변화 추적 |

**인풋 데이터:**
```python
revenue_df = df[df['손익분류'] == '매출']
monthly = revenue_df.groupby(['월', '계정과목'])['순액'].sum().unstack(fill_value=0)
```

**계산식:**
```python
# 피벗: index=월, columns=계정과목, values=sum(순액)
# 스택으로 누적 표시
```

---

### 08. 월별 판관비 구성

| 항목 | 내용 |
|------|------|
| **목표** | 월별 판관비를 주요 계정과목별로 분해 |
| **차트 유형** | 스택 막대 그래프 |
| **인사이트** | 비용 항목별 월별 변동 파악 |

**인풋 데이터:**
```python
expense_df = df[df['손익분류'] == '판관비']
monthly = expense_df.groupby(['월', '계정과목'])['순액'].sum().unstack(fill_value=0)
```

**계산식:**
```python
# 상위 5개 계정과목 + 기타
top_accounts = monthly.sum().nlargest(5).index
monthly_top = monthly[top_accounts]
monthly_top['기타'] = monthly.drop(columns=top_accounts).sum(axis=1)
```

---

### 09. 월별 거래 건수

| 항목 | 내용 |
|------|------|
| **목표** | 월별 거래 건수 파악 및 평균 대비 비교 |
| **차트 유형** | 막대 그래프 + 평균선 |
| **인사이트** | 업무량 패턴, 이상 월 식별 |

**인풋 데이터:**
```python
monthly_count = df.groupby('월').size()
# Series: index=월, values=건수
```

**계산식:**
```python
평균 = monthly_count.mean()
# 평균선으로 표시하여 평균 대비 높낮이 비교
```

---

### 10. 월별 평균 거래 금액

| 항목 | 내용 |
|------|------|
| **목표** | 월별 평균 거래 금액 추이 파악 |
| **차트 유형** | 라인 차트 + 면적 채우기 |
| **인사이트** | 거래 규모 변화 추적 |

**인풋 데이터:**
```python
monthly_avg = df.groupby('월')['순액'].mean()
```

**계산식:**
```python
월별 평균 = sum(순액) / count(거래)
```

---

## 3. 거래처 분석 (5개)

### 11. 판관비 거래처 TOP 10

| 항목 | 내용 |
|------|------|
| **목표** | 판관비 지출이 가장 많은 거래처 식별 |
| **차트 유형** | 가로 막대 그래프 |
| **인사이트** | 주요 공급업체 파악, 협상력 분석 |

**인풋 데이터:**
```python
expense_df = df[df['손익분류'] == '판관비']
top_traders = expense_df.groupby('거래처명_filled')['순액'].sum().nlargest(10)
```

**계산식:**
```python
거래처별 합계 = sum(순액) group by 거래처명
TOP 10 = 내림차순 정렬 후 상위 10개
```

---

### 12. 매출 거래처 TOP 10

| 항목 | 내용 |
|------|------|
| **목표** | 매출 기여가 가장 큰 거래처 식별 |
| **차트 유형** | 가로 막대 그래프 |
| **인사이트** | 핵심 고객 파악, 매출 집중도 분석 |

**인풋 데이터:**
```python
revenue_df = df[df['손익분류'] == '매출']
top_traders = revenue_df.groupby('거래처명_filled')['순액'].sum().nlargest(10)
```

**계산식:**
```python
# 매출 손익분류만 필터링 후 거래처별 합계
```

---

### 13. 거래처 집중도 (파레토 분석)

| 항목 | 내용 |
|------|------|
| **목표** | 거래처 집중도 분석 (80/20 법칙) |
| **차트 유형** | 막대 + 누적 라인 (파레토 차트) |
| **인사이트** | 상위 몇 개 거래처가 전체의 80%를 차지하는지 파악 |

**인풋 데이터:**
```python
expense_df = df[df['손익분류'] == '판관비']
trader_sum = expense_df.groupby('거래처명_filled')['순액'].sum().sort_values(ascending=False)
```

**계산식:**
```python
누적비율 = cumsum(금액) / sum(전체금액) * 100

# 예시:
# 1위 거래처: 20%
# 1~2위 누적: 35%
# 1~5위 누적: 60%
# 80% 도달 지점 확인
```

---

### 14. 계정과목별 거래처 수

| 항목 | 내용 |
|------|------|
| **목표** | 각 비용 항목에 몇 개의 거래처가 관련되어 있는지 파악 |
| **차트 유형** | 가로 막대 그래프 |
| **인사이트** | 거래처 분산도, 협상력 분석 |

**인풋 데이터:**
```python
expense_df = df[df['손익분류'] == '판관비']
trader_count = expense_df.groupby('계정과목')['거래처명_filled'].nunique()
```

**계산식:**
```python
거래처 수 = count(distinct 거래처명) group by 계정과목
```

---

### 15. 주요 거래처 월별 패턴

| 항목 | 내용 |
|------|------|
| **목표** | TOP 5 거래처의 월별 거래 패턴 비교 |
| **차트 유형** | 다중 라인 차트 |
| **인사이트** | 거래처별 계절성, 정기 거래 패턴 파악 |

**인풋 데이터:**
```python
expense_df = df[df['손익분류'] == '판관비']
top5_traders = expense_df.groupby('거래처명_filled')['순액'].sum().nlargest(5).index

for trader in top5_traders:
    monthly = expense_df[expense_df['거래처명_filled'] == trader].groupby('월')['순액'].sum()
```

**계산식:**
```python
# 각 거래처별로 월별 합계 계산하여 라인으로 표시
```

---

## 4. 증빙유형별 분석 (4개)

### 16. 증빙유형별 금액 현황

| 항목 | 내용 |
|------|------|
| **목표** | 증빙유형(세금계산서, 카드, 현금영수증 등)별 금액 분포 |
| **차트 유형** | 가로 막대 그래프 |
| **인사이트** | 결제 수단 다양성, 증빙 관리 현황 |

**인풋 데이터:**
```python
data = df.groupby('증빙유형명')['순액'].sum()
```

**계산식:**
```python
증빙유형별 합계 = sum(순액) group by 증빙유형명
# 증빙유형명: 수기, 세금계산서, 카드, 현금영수증, 통장자동 등
```

**증빙유형 코드:**
| 코드 | 명칭 |
|------|------|
| 0 | 수기 |
| 1 | 현금조정 |
| 5 | 결산분개 |
| 40 | 원천세 |
| 86 | 세금계산서 |
| 87 | 영세율 |
| 88 | 카드 |
| 88.5 | 카드미반영 |
| 89 | 현금영수증 |
| 90 | 통장자동 |

---

### 17. 증빙유형별 건수 비율

| 항목 | 내용 |
|------|------|
| **목표** | 증빙유형별 거래 건수 비율 파악 |
| **차트 유형** | 파이 차트 |
| **인사이트** | 가장 빈번한 증빙 유형 식별 |

**인풋 데이터:**
```python
data = df['증빙유형명'].value_counts()
```

**계산식:**
```python
건수 비율 = (각 증빙유형 건수 / 전체 건수) * 100
```

---

### 18. 손익분류별 증빙유형 분포

| 항목 | 내용 |
|------|------|
| **목표** | 각 손익분류(매출, 비용 등)에서 어떤 증빙유형이 사용되는지 분석 |
| **차트 유형** | 스택 막대 그래프 |
| **인사이트** | 비용 항목별 결제 수단 패턴 |

**인풋 데이터:**
```python
pivot = df.pivot_table(
    index='손익분류',
    columns='증빙유형명',
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

**계산식:**
```python
# 2차원 피벗: 손익분류 × 증빙유형 = sum(순액)
```

---

### 19. 월별 증빙유형 추이

| 항목 | 내용 |
|------|------|
| **목표** | 월별로 증빙유형 사용 패턴 변화 추적 |
| **차트 유형** | 다중 라인 차트 |
| **인사이트** | 결제 수단 사용 변화 추이 |

**인풋 데이터:**
```python
pivot = df.pivot_table(
    index='월',
    columns='증빙유형명',
    values='순액',
    aggfunc='count',  # 건수 기준
    fill_value=0
)
```

**계산식:**
```python
월별 증빙유형 건수 = count(*) group by 월, 증빙유형명
```

---

## 5. 카드/현금 분석 (3개)

### 20. 결제수단별 비교

| 항목 | 내용 |
|------|------|
| **목표** | 카드, 현금, 세금계산서 등 결제수단별 금액/건수 비율 비교 |
| **차트 유형** | 파이 차트 (2개: 금액, 건수) |
| **인사이트** | 주요 결제 수단 파악 |

**인풋 데이터:**
```python
card = df[df['증빙유형'] == 88]      # 카드
cash = df[df['증빙유형'] == 89]      # 현금영수증
tax = df[df['증빙유형'] == 86]       # 세금계산서
other = df[~df['증빙유형'].isin([88, 89, 86])]  # 기타
```

**계산식:**
```python
# 금액 기준
card_amount = abs(card['순액'].sum())
cash_amount = abs(cash['순액'].sum())
...

# 건수 기준
card_count = len(card)
cash_count = len(cash)
...
```

---

### 21. 카드미반영 분석

| 항목 | 내용 |
|------|------|
| **목표** | 분개장에 반영되지 않은 카드 거래 현황 분석 |
| **차트 유형** | 막대 그래프 (월별) + 가로 막대 (거래처별) |
| **인사이트** | 미처리 거래 규모, 주요 미반영 거래처 식별 |

**인풋 데이터:**
```python
card_missing = df[df['증빙유형'] == 88.5]  # 카드미반영
```

**계산식:**
```python
# 월별 카드미반영 금액
monthly = card_missing.groupby('월')['순액'].sum()

# 거래처별 카드미반영 TOP 10
top_traders = card_missing.groupby('거래처명_filled')['순액'].sum().nlargest(10)
```

**중요도:**
- 카드미반영(88.5)은 **수동 계정 지정이 필요**한 거래
- 총 건수와 금액을 제목에 표시

---

### 22. 카드 공제/불공제 현황

| 항목 | 내용 |
|------|------|
| **목표** | 카드 거래 중 세금 공제 가능/불가능 비율 파악 |
| **차트 유형** | 파이 차트 |
| **인사이트** | 세금 절감 기회 분석 |

**인풋 데이터:**
```python
card_df = df[df['증빙유형'] == 88]
deduction = card_df.groupby('공제구분')['순액'].sum().abs()
```

**계산식:**
```python
공제 비율 = (공제 금액 / 전체 카드 금액) * 100
불공제 비율 = (불공제 금액 / 전체 카드 금액) * 100
```

---

## 6. 이상거래 탐지 (4개)

### 23. 이상치 탐지 (박스플롯)

| 항목 | 내용 |
|------|------|
| **목표** | 통계적 이상치(아웃라이어) 시각적 탐지 |
| **차트 유형** | 박스플롯 (손익분류별, 월별) |
| **인사이트** | 비정상적으로 큰/작은 거래 식별 |

**인풋 데이터:**
```python
# 손익분류별
expense_df = df[df['손익분류'].isin(['판관비', '매출원가'])]

# 월별
df['월']
```

**계산식:**
```python
# 박스플롯 통계:
Q1 = 25% 백분위수
Q3 = 75% 백분위수
IQR = Q3 - Q1
이상치 기준 = Q1 - 1.5*IQR 미만 또는 Q3 + 1.5*IQR 초과
```

---

### 24. 고액 거래 TOP 20

| 항목 | 내용 |
|------|------|
| **목표** | 상위 1% 고액 거래 상세 내역 파악 |
| **차트 유형** | 가로 막대 그래프 (양/음 구분) |
| **인사이트** | 대규모 거래 검토, 이상 거래 탐지 |

**인풋 데이터:**
```python
threshold = df['순액'].abs().quantile(0.99)  # 상위 1% 기준값
large_trans = df[df['순액'].abs() >= threshold]
```

**계산식:**
```python
# 상위 1% 기준값 계산
threshold = np.percentile(abs(순액), 99)

# 기준값 이상 거래 필터링 후 TOP 20
large_trans = large_trans.sort_values('순액', ascending=False).head(20)
```

**표시 정보:**
- 계정과목 - 거래처명
- 양수(수입): 녹색, 음수(지출): 빨간색

---

### 25. 주말/평일 거래 분석

| 항목 | 내용 |
|------|------|
| **목표** | 주말 거래 이상 여부 확인 |
| **차트 유형** | 파이 차트 (금액 비율) + 막대 그래프 (요일별 건수) |
| **인사이트** | 비정상 주말 거래 탐지 (일반적으로 주말 거래는 적음) |

**인풋 데이터:**
```python
df['요일'] = df['회계일자'].dt.dayofweek  # 0=월, 6=일
weekend = df[df['요일'].isin([5, 6])]  # 토, 일
weekday = df[~df['요일'].isin([5, 6])]  # 평일
```

**계산식:**
```python
주말 금액 비율 = (주말 순액 합계 / 전체 순액 합계) * 100
요일별 건수 = count(*) group by 요일
```

---

### 26. 금액 구간별 분포

| 항목 | 내용 |
|------|------|
| **목표** | 거래 금액 규모별 분포 파악 |
| **차트 유형** | 막대 그래프 |
| **인사이트** | 소액/대액 거래 비중 파악 |

**인풋 데이터:**
```python
df['금액구간'] = df['순액'].apply(get_range)
```

**계산식:**
```python
def get_range(x):
    abs_x = abs(x)
    if abs_x < 100_000:
        return '10만 미만'
    elif abs_x < 500_000:
        return '10~50만'
    elif abs_x < 1_000_000:
        return '50~100만'
    elif abs_x < 5_000_000:
        return '100~500만'
    else:
        return '500만 이상'

구간별 건수 = count(*) group by 금액구간
```

**구간 정의:**
| 구간 | 범위 |
|------|------|
| 10만 미만 | 0 ~ 99,999원 |
| 10~50만 | 100,000 ~ 499,999원 |
| 50~100만 | 500,000 ~ 999,999원 |
| 100~500만 | 1,000,000 ~ 4,999,999원 |
| 500만 이상 | 5,000,000원 ~ |

---

## 7. 기타 인사이트 (4개)

### 27. 소스유형별 비교

| 항목 | 내용 |
|------|------|
| **목표** | 분개장(vat), 분개장(일반), 카드미반영 비율 비교 |
| **차트 유형** | 파이 차트 (금액, 건수) |
| **인사이트** | 데이터 소스별 구성 파악 |

**인풋 데이터:**
```python
source_amount = df.groupby('소스유형')['순액'].sum()
source_count = df.groupby('소스유형').size()
```

**계산식:**
```python
# 소스유형 분류 (전표번호 기준)
if 데이터소스 == '카드미반영':
    소스유형 = '카드미반영'
elif 전표번호 >= 50000:
    소스유형 = '분개장(vat)'  # 매입매출장 파생
else:
    소스유형 = '분개장(일반)'  # 일반 분개
```

---

### 28. 계정과목 × 월 히트맵

| 항목 | 내용 |
|------|------|
| **목표** | 계정과목별 월별 금액을 히트맵으로 시각화 |
| **차트 유형** | 히트맵 (Heatmap) |
| **인사이트** | 특정 계정의 월별 집중도, 계절성 패턴 |

**인풋 데이터:**
```python
expense_df = df[df['손익분류'] == '판관비']
pivot = expense_df.pivot_table(
    index='계정과목',
    columns='월',
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

**계산식:**
```python
# 상위 15개 계정과목만 표시
top_accounts = pivot.sum(axis=1).nlargest(15).index
pivot = pivot.loc[top_accounts]

# 백만원 단위로 표시
pivot_display = pivot / 1_000_000
```

**색상:**
- 낮은 값: 노란색
- 높은 값: 빨간색 (YlOrRd 컬러맵)

---

### 29. 누적 금액 추이

| 항목 | 내용 |
|------|------|
| **목표** | 월별 누적 매출/비용 추이 파악 |
| **차트 유형** | 라인 차트 (누적) |
| **인사이트** | 연간 목표 대비 진행률, 비용 누적 속도 |

**인풋 데이터:**
```python
for pl_type in ['매출', '매출원가', '판관비']:
    monthly = df[df['손익분류'] == pl_type].groupby('월')['순액'].sum()
    cumsum = monthly.reindex(range(1, 13), fill_value=0).cumsum()
```

**계산식:**
```python
# 월별 순액 합계의 누적 합계
1월 누적 = 1월 합계
2월 누적 = 1월 합계 + 2월 합계
...
12월 누적 = 1월~12월 합계
```

---

### 30. 종합 대시보드

| 항목 | 내용 |
|------|------|
| **목표** | 핵심 지표를 한 화면에 요약 |
| **차트 유형** | 복합 (KPI + 라인 + 파이 + 막대) |
| **인사이트** | 경영진 보고용 요약 대시보드 |

**구성 요소:**

| 위치 | 내용 | 유형 |
|------|------|------|
| 좌상단 | 핵심 지표 (매출, 영업이익) | KPI 텍스트 |
| 우상단 | 월별 매출/판관비 추이 | 라인 차트 |
| 좌중단 | 손익분류 비율 | 파이 차트 |
| 중중단 | 증빙유형 TOP 5 | 가로 막대 |
| 우중단 | 판관비 거래처 TOP 5 | 가로 막대 |
| 하단 | 데이터 요약 정보 | 텍스트 |

**계산식:**
```python
# 핵심 지표
매출 = df[df['손익분류'] == '매출']['순액'].sum()
매출원가 = df[df['손익분류'] == '매출원가']['순액'].sum()
판관비 = df[df['손익분류'] == '판관비']['순액'].sum()
영업이익 = 매출 - 매출원가 - 판관비

# 요약 정보
총 거래 건수 = len(df)
거래처 수 = df['거래처명_filled'].nunique()
계정과목 수 = df['계정과목'].nunique()
카드미반영 건수 = len(df[df['증빙유형'] == 88.5])
```

---

## 출력 사양

### 이미지 설정

| 항목 | 값 |
|------|------|
| 해상도 | 150 DPI |
| 형식 | PNG |
| 배경색 | 흰색 (white) |
| 크기 | 차트별 상이 (10x6 ~ 16x12 인치) |

### 파일명 규칙

```
{순번:02d}_{차트명}.png

예시:
01_손익분류별_총액.png
02_매출_원가_판관비_비교.png
...
30_종합_대시보드.png
```

---

## 실행 방법

```bash
cd analyze_merged_data
uv run python src/create_charts.py
```

**출력:**
```
output/{회사명}/charts_{mm-dd-hh-mm}/
├── 01_손익분류별_총액.png
├── 02_매출_원가_판관비_비교.png
├── ...
└── 30_종합_대시보드.png
```
