# 02-2. 기본_거래처추가_피벗 분석

## 개요

기본피벗에 거래처 컬럼을 추가한 상세 피벗 테이블

---

## 목표 결과물

```
정렬순서  손익분류   계정과목      거래처              분개장(vat)  분개장(일반)  분개장요약  카드미반영  총합계
1        매출      의료수입      국민건강보험공단         0        500.0M      500.0M        0     500.0M
1        매출      의료수입      개인환자A              6.9M       300.0M      306.9M        0     306.9M
1        매출      의료수입      개인환자B               0        191.0M      191.0M        0     191.0M
2        매출원가  의약품비      도매약품주식회사       247.0M        0        247.0M        0     247.0M
3        판관비    복리후생비    스타벅스                 0          0           0        3.2M      3.2M
3        판관비    복리후생비    이디야커피               0          0           0        2.4M      2.4M
...
```

---

## 로직

### Step 1: 거래처명 전처리

```python
# 거래처명이 비어있으면 "(미지정)"으로 처리
df['거래처명_filled'] = df['거래처명'].fillna('(미지정)').replace('', '(미지정)')
```

### Step 2: 피벗 테이블 생성

```python
pivot_trader = df.pivot_table(
    index=['정렬순서', '손익분류', '계정과목', '거래처명_filled'],
    columns='소스유형',
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

### Step 3: 열 순서 정리

```python
base_cols = ['분개장(vat)', '분개장(일반)']
pivot_trader = pivot_trader.reindex(
    columns=[c for c in base_cols if c in pivot_trader.columns],
    fill_value=0
)
```

### Step 4: 분개장요약 추가

```python
if '분개장(vat)' in pivot_trader.columns and '분개장(일반)' in pivot_trader.columns:
    pivot_trader['분개장요약'] = pivot_trader['분개장(vat)'] + pivot_trader['분개장(일반)']
elif '분개장(vat)' in pivot_trader.columns:
    pivot_trader['분개장요약'] = pivot_trader['분개장(vat)']
elif '분개장(일반)' in pivot_trader.columns:
    pivot_trader['분개장요약'] = pivot_trader['분개장(일반)']
else:
    pivot_trader['분개장요약'] = 0
```

### Step 5: 카드미반영 추가

```python
card_missing_trader = df[df['데이터소스'] == '카드미반영'].groupby(
    ['정렬순서', '손익분류', '계정과목', '거래처명_filled']
)['순액'].sum()
pivot_trader['카드미반영'] = card_missing_trader.reindex(pivot_trader.index, fill_value=0)
```

### Step 6: 총합계 및 정렬

```python
# 총합계
pivot_trader['총합계'] = pivot_trader[['분개장요약', '카드미반영']].sum(axis=1)

# 정렬: 정렬순서 → 손익분류 → 계정과목 → 분개장요약(내림차순)
pivot_trader = pivot_trader.reset_index()
pivot_trader = pivot_trader.sort_values(
    by=['정렬순서', '손익분류', '계정과목', '분개장요약'],
    ascending=[True, True, True, False]
)

# 인덱스 재설정
pivot_trader = pivot_trader.rename(columns={'거래처명_filled': '거래처'})
pivot_trader = pivot_trader.set_index(['정렬순서', '손익분류', '계정과목', '거래처'])
```

---

## 정렬 규칙

| 순서 | 기준 | 방향 |
|:----:|------|:----:|
| 1 | 정렬순서 | 오름차순 |
| 2 | 손익분류 | 오름차순 |
| 3 | 계정과목 | 오름차순 |
| 4 | 분개장요약 | **내림차순** |

> 같은 계정과목 내에서 거래처는 분개장요약 금액이 큰 순서대로 정렬

---

## 기본피벗과의 차이점

| 항목 | 기본피벗 | 기본_거래처추가_피벗 |
|------|----------|----------------------|
| 인덱스 | 정렬순서, 손익분류, 계정과목 | 정렬순서, 손익분류, 계정과목, **거래처** |
| 행 수 | 32행 (계정과목 수) | 58행 (계정과목 × 거래처) |
| 용도 | 전체 요약 | 거래처별 상세 |

---

## 출력 형식

### Excel (기본_거래처추가_피벗 시트)

```
정렬순서 | 손익분류 | 계정과목 | 거래처 | 분개장(vat) | 분개장(일반) | 분개장요약 | 카드미반영 | 총합계
```

### JSON

```json
{
  "기본_거래처추가_피벗": [
    {
      "정렬순서": 1,
      "손익분류": "매출",
      "계정과목": "의료수입",
      "거래처": "국민건강보험공단",
      "분개장(vat)": 0,
      "분개장(일반)": 500000000,
      "분개장요약": 500000000,
      "카드미반영": 0,
      "총합계": 500000000
    },
    ...
  ]
}
```

---

## 주의사항

1. **거래처명 null 처리**: 비어있는 거래처는 "(미지정)"으로 표시
2. **정렬 순서**: 계정과목 내에서 분개장요약 금액 내림차순
3. **컬럼 순서**: 기본피벗과 동일 (분개장(vat) → 분개장(일반) → 분개장요약 → 카드미반영 → 총합계)
