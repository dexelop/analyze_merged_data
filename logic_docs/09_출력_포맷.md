# 09. 출력 포맷

## 개요

분석 결과를 Excel과 JSON으로 출력

---

## 출력 경로

```
output/{회사명}/
├── 분석결과.xlsx
└── 분석결과.json
```

---

## Excel 출력

### 시트 구성

| 시트명 | 내용 | 인덱스 |
|--------|------|:------:|
| 기본피벗 | 정렬순서 × 손익분류 × 계정과목 × 소스유형 | O |
| 월별추이 | 손익분류 × 월 + 합계/평균 | O |
| 거래처TOP | 계정과목별 거래처 TOP 10 | X |
| 증빙유형별 | 손익분류 × 계정과목 × 증빙유형명 | O |
| 카드현황 | 계정과목 × (공제구분, 전표상태) | O |
| 카드미반영 | 미처리 거래 상세 목록 | X |
| 이상거래 | 이상 탐지 결과 (선택) | X |

### 코드

```python
from pathlib import Path
import pandas as pd

def export_excel(output_dir: Path, **dataframes):
    """
    여러 DataFrame을 하나의 Excel 파일로 출력

    Args:
        output_dir: 출력 디렉토리
        **dataframes: 시트명=DataFrame 형태
    """
    excel_path = output_dir / "분석결과.xlsx"

    with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
        for sheet_name, df in dataframes.items():
            if df is None or len(df) == 0:
                continue

            # MultiIndex인 경우 인덱스 포함, 아니면 제외
            has_multi_index = isinstance(df.index, pd.MultiIndex)
            df.to_excel(
                writer,
                sheet_name=sheet_name,
                index=has_multi_index or df.index.name is not None
            )

    print(f"Excel 저장: {excel_path}")
    return excel_path
```

### 사용 예시

```python
export_excel(
    OUTPUT_DIR,
    기본피벗=pivot_basic,
    월별추이=monthly_trend,
    거래처TOP=trade_top10,
    증빙유형별=evidence_analysis,
    카드현황=card_status,
    카드미반영=card_missing_detail
)
```

---

## JSON 출력

### 구조

```json
{
  "meta": {
    "회사명": "example",
    "기간": "2024",
    "총건수": 675,
    "생성일시": "2026-01-05T18:35:00.000000"
  },
  "기본피벗": [...],
  "월별추이": [...],
  "거래처TOP": [...],
  "증빙유형별": [...],
  "카드미반영": [...]
}
```

### DataFrame → JSON 변환

```python
def df_to_dict(df: pd.DataFrame) -> list:
    """
    DataFrame을 JSON 직렬화 가능한 리스트로 변환

    처리 사항:
    - MultiIndex → reset_index()
    - int64/float64 → Python native int/float
    - NaN → None
    """
    result = df.copy()

    # MultiIndex 처리
    if isinstance(result.index, pd.MultiIndex):
        result = result.reset_index()

    # 숫자 타입 변환
    for col in result.columns:
        if result[col].dtype in ['int64', 'float64']:
            result[col] = result[col].apply(
                lambda x: int(x) if pd.notna(x) and x == int(x)
                else float(x) if pd.notna(x)
                else None
            )

    return result.to_dict(orient='records')
```

### 전체 출력 함수

```python
import json
from datetime import datetime

def export_json(output_dir: Path, company_name: str, total_count: int, **dataframes):
    """
    분석 결과를 JSON으로 출력
    """
    json_output = {
        "meta": {
            "회사명": company_name,
            "기간": "2024",
            "총건수": total_count,
            "생성일시": datetime.now().isoformat()
        }
    }

    for key, df in dataframes.items():
        if df is None or len(df) == 0:
            json_output[key] = []
        else:
            json_output[key] = df_to_dict(df.reset_index() if hasattr(df.index, 'names') else df)

    json_path = output_dir / "분석결과.json"
    with open(json_path, 'w', encoding='utf-8') as f:
        json.dump(json_output, f, ensure_ascii=False, indent=2)

    print(f"JSON 저장: {json_path}")
    return json_path
```

---

## 콘솔 요약 출력

```python
def print_summary(df, monthly_trend):
    """분석 완료 후 콘솔 요약"""

    print("\n" + "=" * 60)
    print("분석 완료!")
    print("=" * 60)

    print(f"\n[데이터 요약]")
    print(f"  - 총 건수: {len(df):,}건")
    print(f"  - 기간: 2024년 {df['월'].min()}월 ~ {df['월'].max()}월")

    print(f"\n[손익 요약]")
    for idx, row in monthly_trend.iterrows():
        print(f"  - {idx}: {row['합계']:,.0f}원")

    print(f"\n[출력 파일]")
    print(f"  - Excel: {OUTPUT_DIR / '분석결과.xlsx'}")
    print(f"  - JSON: {OUTPUT_DIR / '분석결과.json'}")
```

---

## 파일 인코딩

| 파일 | 인코딩 |
|------|--------|
| Excel (.xlsx) | UTF-8 (openpyxl 기본) |
| JSON | UTF-8, ensure_ascii=False |

---

## 주의사항

1. **ensure_ascii=False**: 한글 유니코드 그대로 저장
2. **indent=2**: 가독성을 위한 들여쓰기
3. **NaN 처리**: JSON은 NaN 지원 안 함 → None 변환
4. **int64 변환**: numpy int64 → Python int (JSON 호환)
