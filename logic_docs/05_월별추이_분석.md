# 05. 월별 추이 분석

## 개요

손익분류별 월별 금액 추이 및 평균 분석

---

## 로직

### Step 1: 피벗 테이블 생성

```python
monthly_trend = df.pivot_table(
    index='손익분류',
    columns='월',
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

### Step 2: 합계/평균 계산

```python
# 합계 (전체 월 합산)
monthly_trend['합계'] = monthly_trend.sum(axis=1)

# 평균 (합계 제외한 월별 평균)
monthly_trend['평균'] = monthly_trend.iloc[:, :-1].mean(axis=1).round(0)
```

### Step 3: 정렬순서 기준 정렬

```python
# 손익분류별 정렬순서 추출 (첫 번째 값 사용)
sort_order = df.groupby('손익분류')['정렬순서'].first().sort_values()

# 정렬순서대로 재정렬
monthly_trend = monthly_trend.reindex(sort_order.index)
```

---

## 목표 결과물

```
손익분류        01월      02월      03월     ...    12월       합계       평균
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
매출         80.3M     82.1M     78.5M          85.2M     960.0M     80.0M
매출원가      5.7M      5.9M      5.5M           6.1M      68.0M      5.7M
판관비       47.6M     48.2M     46.8M          52.1M     570.0M     47.5M
영업외수익    1.2M      1.1M      1.3M           1.0M      14.0M      1.2M
영업외비용    0.5M      0.6M      0.4M           0.5M       6.0M      0.5M
```

---

## 추가 분석 (선택)

### 전월 대비 증감률

```python
# 월별 컬럼만 추출
month_cols = [c for c in monthly_trend.columns if c not in ['합계', '평균']]

# 전월 대비 증감률
for i, month in enumerate(month_cols[1:], 1):
    prev_month = month_cols[i-1]
    monthly_trend[f'{month}_증감률'] = (
        (monthly_trend[month] - monthly_trend[prev_month]) /
        monthly_trend[prev_month].replace(0, 1) * 100
    ).round(1)
```

### 추세 방향

```python
def get_trend(row):
    """
    단순 선형 추세 판단
    - ↑: 상승 추세
    - ↓: 하락 추세
    - →: 보합
    """
    months = [c for c in row.index if c not in ['합계', '평균']]
    values = row[months].values

    if len(values) < 3:
        return '→'

    # 전반부 평균 vs 후반부 평균
    mid = len(values) // 2
    first_half = values[:mid].mean()
    second_half = values[mid:].mean()

    change_rate = (second_half - first_half) / max(abs(first_half), 1) * 100

    if change_rate > 10:
        return '↑'
    elif change_rate < -10:
        return '↓'
    return '→'

monthly_trend['추세'] = monthly_trend.apply(get_trend, axis=1)
```

---

## 출력 형식

### Excel (월별추이 시트)

```
손익분류 | 01 | 02 | 03 | ... | 12 | 합계 | 평균
```

### JSON

```json
{
  "월별추이": [
    {
      "손익분류": "매출",
      "01": 80322456,
      "02": 82100000,
      ...
      "12": 85200000,
      "합계": 960000000,
      "평균": 80000000
    },
    ...
  ]
}
```

---

## 정렬순서 매핑

| 정렬순서 | 손익분류 |
|:--------:|----------|
| 1 | 매출 |
| 2 | 매출원가 |
| 3 | 판관비 |
| 4 | 영업외수익 |
| 5 | 영업외비용 |
| 10+ | BS 항목 |

---

## 주의사항

1. **월 컬럼 타입**: 문자열 '01', '02' 형식 유지
2. **평균 계산**: 합계 컬럼 제외하고 계산
3. **정렬 기준**: 정렬순서 오름차순 (매출 → 판관비 순)
