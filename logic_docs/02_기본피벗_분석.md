# 02. 기본 피벗 분석

## 개요

손익계산서 구조를 따르는 기본 요약 피벗 테이블 생성

---

## 목표 결과물

```
                      분개장(vat)  분개장(일반)  분개장요약  카드미반영  총합계
정렬순서  손익분류   계정과목
1        매출      의료수입        6.9M       991.0M    998.0M        0    998.0M
                   보험의료수입      0         18.5M     18.5M        0     18.5M
2        매출원가  의약품비(즉시)  247.0M        0      247.0M        0    247.0M
3        판관비    복리후생비        0           0          0      5.6M      5.6M
                   급여              0        800.0M    800.0M        0    800.0M
...
```

---

## 로직

### Step 1: 피벗 테이블 생성

```python
pivot_basic = df.pivot_table(
    index=['정렬순서', '손익분류', '계정과목'],
    columns='소스유형',              # 분개장(vat), 분개장(일반), 카드미반영
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

### Step 2: 열 순서 정리

```python
col_order = ['분개장(vat)', '분개장(일반)', '카드미반영']
pivot_basic = pivot_basic.reindex(
    columns=[c for c in col_order if c in pivot_basic.columns],
    fill_value=0
)
```

### Step 3: 총합계 계산 (분개장요약 추가 전!)

```python
# 중요: 분개장요약을 추가하기 전에 총합계 계산
pivot_basic['총합계'] = pivot_basic.sum(axis=1)
```

### Step 4: 분개장요약 컬럼 추가

```python
# 분개장(vat) + 분개장(일반)
if '분개장(vat)' in pivot_basic.columns and '분개장(일반)' in pivot_basic.columns:
    pivot_basic['분개장요약'] = pivot_basic['분개장(vat)'] + pivot_basic['분개장(일반)']
elif '분개장(vat)' in pivot_basic.columns:
    pivot_basic['분개장요약'] = pivot_basic['분개장(vat)']
elif '분개장(일반)' in pivot_basic.columns:
    pivot_basic['분개장요약'] = pivot_basic['분개장(일반)']
```

### Step 5: 정렬

```python
# 정렬순서(level=0) 기준 정렬
pivot_basic = pivot_basic.sort_index(level=0)
```

---

## 정렬순서 의미

| 정렬순서 | 손익분류 | 설명 |
|:--------:|----------|------|
| 1 | 매출 | 영업수익 |
| 2 | 매출원가 | 직접비용 |
| 3 | 판관비 | 판매비와관리비 |
| 4 | 영업외수익 | 이자수익, 잡이익 등 |
| 5 | 영업외비용 | 이자비용, 잡손실 등 |
| 10+ | (BS 항목) | 자산, 부채, 자본 |
| 99 | 카드미반영 | 미처리 카드거래 |

---

## 출력 형식

### Excel (기본피벗 시트)

```
정렬순서 | 손익분류 | 계정과목 | 분개장(vat) | 분개장(일반) | 카드미반영 | 총합계 | 분개장요약
```

### JSON

```json
{
  "기본피벗": [
    {
      "정렬순서": 1,
      "손익분류": "매출",
      "계정과목": "의료수입",
      "분개장(vat)": 6975737,
      "분개장(일반)": 991063845,
      "카드미반영": 0,
      "총합계": 998039582,
      "분개장요약": 998039582
    },
    ...
  ]
}
```

---

## 주의사항

1. **총합계 계산 순서**: 반드시 분개장요약 추가 전에 계산 (중복 방지)
2. **fill_value=0**: 데이터 없는 셀은 0으로 채움
3. **정렬순서 기준**: MultiIndex의 level=0으로 정렬
