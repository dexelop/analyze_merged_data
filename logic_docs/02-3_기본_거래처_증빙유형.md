# 02-3. 기본_거래처_증빙유형 분석

## 개요

기본피벗에 거래처와 증빙유형 컬럼을 추가한 상세 피벗 테이블

---

## 목표 결과물

```
정렬순서  손익분류  계정과목    거래처           증빙유형    분개장(vat)  분개장(일반)  분개장요약  카드미반영  총합계
1        매출     의료수입   국민건강보험공단   수기            0        200M       200M        0      200M
1        매출     의료수입   국민건강보험공단   현금조정        0          0          0         0        0
1        매출     의료수입   국민건강보험공단   결산분개        0          0          0         0        0
1        매출     의료수입   국민건강보험공단   원천세          0          0          0         0        0
1        매출     의료수입   국민건강보험공단   세금계산서    100M       200M       300M        0      300M
1        매출     의료수입   국민건강보험공단   영세율          0          0          0         0        0
1        매출     의료수입   국민건강보험공단   카드            0          0          0         0        0
1        매출     의료수입   국민건강보험공단   카드미반영      0          0          0         0        0
1        매출     의료수입   국민건강보험공단   현금영수증      0          0          0         0        0
1        매출     의료수입   국민건강보험공단   통장자동        0          0          0         0        0
1        매출     의료수입   개인환자A         수기            0          0          0         0        0
...
```

---

## 로직

### Step 1: 증빙유형 코드 순서 정의

```python
ev_type_order = [0, 1, 5, 40, 86, 87, 88, 88.5, 89, 90]
```

| 코드 | 증빙유형명 |
|:----:|------------|
| 0 | 수기 |
| 1 | 현금조정 |
| 5 | 결산분개 |
| 40 | 원천세 |
| 86 | 세금계산서 |
| 87 | 영세율 |
| 88 | 카드 |
| 88.5 | 카드미반영 |
| 89 | 현금영수증 |
| 90 | 통장자동 |

### Step 2: 기본 피벗 생성

```python
pivot_trader_ev = df.pivot_table(
    index=['정렬순서', '손익분류', '계정과목', '거래처명_filled', '증빙유형'],
    columns='소스유형',
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

### Step 3: 컬럼 추가

```python
# 분개장요약 = 분개장(vat) + 분개장(일반)
pivot_trader_ev['분개장요약'] = pivot_trader_ev['분개장(vat)'] + pivot_trader_ev['분개장(일반)']

# 카드미반영 컬럼
card_missing = df[df['데이터소스'] == '카드미반영'].groupby(...)['순액'].sum()
pivot_trader_ev['카드미반영'] = card_missing.reindex(pivot_trader_ev.index, fill_value=0)

# 총합계
pivot_trader_ev['총합계'] = pivot_trader_ev[['분개장요약', '카드미반영']].sum(axis=1)
```

### Step 4: 거래처별 합계 계산 (정렬용)

```python
trader_summary = pivot_trader_ev.groupby(
    ['정렬순서', '손익분류', '계정과목', '거래처명_filled']
)['분개장요약'].sum().reset_index()
trader_summary = trader_summary.rename(columns={'분개장요약': '거래처_분개장요약_합계'})

pivot_trader_ev = pivot_trader_ev.merge(trader_summary, on=[...])
```

### Step 5: 모든 증빙유형 행 생성 (빈 행 채우기)

```python
# 모든 (계정과목, 거래처) × 모든 증빙유형 조합 생성
unique_combinations = pivot_trader_ev[['정렬순서', '손익분류', '계정과목', '거래처명_filled', '거래처_분개장요약_합계']].drop_duplicates()

all_ev_types = pd.DataFrame({'증빙유형': ev_type_order})
full_index = pd.merge(
    unique_combinations.assign(key=1),
    all_ev_types.assign(key=1),
    on='key'
).drop('key', axis=1)

# 기존 데이터와 병합 (없는 조합은 0으로 채움)
pivot_trader_ev = full_index.merge(pivot_trader_ev, how='left').fillna(0)
```

### Step 6: 정렬

```python
# 증빙유형 순서 매핑
ev_type_sort_order = {v: i for i, v in enumerate(ev_type_order)}
pivot_trader_ev['증빙유형_순서'] = pivot_trader_ev['증빙유형'].map(ev_type_sort_order)

# 정렬
pivot_trader_ev = pivot_trader_ev.sort_values(
    by=['정렬순서', '손익분류', '계정과목', '거래처_분개장요약_합계', '거래처명_filled', '증빙유형_순서'],
    ascending=[True, True, True, False, True, True]
)
```

### Step 7: 증빙유형 dict 변환

```python
evidence_names = {
    0: '수기', 1: '현금조정', 5: '결산분개', 40: '원천세',
    86: '세금계산서', 87: '영세율', 88: '카드', 88.5: '카드미반영',
    89: '현금영수증', 90: '통장자동'
}
pivot_trader_ev['증빙유형'] = pivot_trader_ev['증빙유형'].map(evidence_names)
```

---

## 정렬 규칙

| 순서 | 기준 | 방향 |
|:----:|------|:----:|
| 1 | 정렬순서 | 오름차순 |
| 2 | 손익분류 | 오름차순 |
| 3 | 계정과목 | 오름차순 |
| 4 | 거래처 (분개장요약 합계) | **내림차순** |
| 5 | 증빙유형 (코드) | 오름차순 |

---

## 기본_거래처추가_피벗과의 차이점

| 항목 | 기본_거래처추가_피벗 | 기본_거래처_증빙유형 |
|------|----------------------|----------------------|
| 인덱스 | 정렬순서, 손익분류, 계정과목, 거래처 | + **증빙유형** |
| 행 수 | 58행 | 580행 (58 × 10) |
| 빈 행 | 없음 | 모든 증빙유형 행 생성 (0 채움) |
| 거래처 정렬 | 분개장요약 내림차순 | 분개장요약 **합계** 내림차순 |
| 용도 | 거래처별 요약 | 증빙유형별 상세 |

---

## 출력 형식

### Excel (기본_거래처_증빙유형 시트)

```
정렬순서 | 손익분류 | 계정과목 | 거래처 | 증빙유형 | 분개장(vat) | 분개장(일반) | 분개장요약 | 카드미반영 | 총합계
```

### JSON

```json
{
  "기본_거래처_증빙유형": [
    {
      "정렬순서": 1,
      "손익분류": "매출",
      "계정과목": "의료수입",
      "거래처": "국민건강보험공단",
      "증빙유형": "세금계산서",
      "분개장(vat)": 100000000,
      "분개장(일반)": 200000000,
      "분개장요약": 300000000,
      "카드미반영": 0,
      "총합계": 300000000
    },
    ...
  ]
}
```

---

## 주의사항

1. **빈 행 채우기**: 각 거래처에 대해 10개 증빙유형 행 모두 생성
2. **거래처 정렬**: 개별 행의 분개장요약이 아닌 **거래처별 합계** 기준
3. **증빙유형 순서**: 코드 오름차순 (0→1→5→40→86→87→88→88.5→89→90)
4. **dict 변환**: 숫자 코드를 한글 명칭으로 변환 (88 → "카드")
