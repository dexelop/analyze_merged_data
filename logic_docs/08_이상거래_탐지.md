# 08. 이상 거래 탐지

## 개요

통계적 방법으로 비정상 거래 패턴 식별

---

## 탐지 유형

| 유형 | 설명 | 탐지 방법 |
|------|------|----------|
| 금액이상 | 평균 대비 비정상적으로 큰 금액 | Z-score > 3 |
| 빈도이상 | 평균 대비 비정상적으로 많은 건수 | Z-score > 3 |
| 거래중단 | 이전에 있던 거래가 갑자기 0 | 전월 대비 -100% |
| 급증 | 전월 대비 급격한 증가 | 전월 대비 +200% |
| 급감 | 전월 대비 급격한 감소 | 전월 대비 -50% |
| 마이너스 | 비정상적인 음수 금액 | 순액 < 0 (환불 등) |

---

## 로직

### 1. 금액 이상 탐지 (Z-score)

```python
import numpy as np

def detect_amount_anomaly(df, threshold=3.0):
    """
    Z-score 기반 금액 이상 탐지

    Z = (x - mean) / std
    |Z| > threshold 이면 이상치
    """
    # 계정과목별 집계
    account_stats = df.groupby('계정과목')['순액'].agg(['mean', 'std'])

    anomalies = []
    for _, row in df.iterrows():
        account = row['계정과목']
        amount = row['순액']

        mean = account_stats.loc[account, 'mean']
        std = account_stats.loc[account, 'std']

        if std > 0:
            z_score = (amount - mean) / std
            if abs(z_score) > threshold:
                anomalies.append({
                    '계정과목': account,
                    '금액': amount,
                    '평균': mean,
                    'Z-score': round(z_score, 2),
                    '플래그': '금액이상'
                })

    return pd.DataFrame(anomalies)
```

### 2. 빈도 이상 탐지

```python
def detect_frequency_anomaly(df, threshold=3.0):
    """
    거래 빈도 이상 탐지
    """
    # 계정과목 × 월별 건수
    freq = df.groupby(['계정과목', '월']).size().reset_index(name='건수')

    # 계정과목별 평균/표준편차
    freq_stats = freq.groupby('계정과목')['건수'].agg(['mean', 'std'])

    anomalies = []
    for _, row in freq.iterrows():
        account = row['계정과목']
        count = row['건수']
        month = row['월']

        mean = freq_stats.loc[account, 'mean']
        std = freq_stats.loc[account, 'std']

        if std > 0:
            z_score = (count - mean) / std
            if abs(z_score) > threshold:
                anomalies.append({
                    '계정과목': account,
                    '월': month,
                    '건수': count,
                    '평균건수': mean,
                    'Z-score': round(z_score, 2),
                    '플래그': '빈도이상'
                })

    return pd.DataFrame(anomalies)
```

### 3. 전월 대비 급변 탐지

```python
def detect_mom_change(df, increase_threshold=2.0, decrease_threshold=-0.5):
    """
    전월 대비 증감률 기반 탐지

    increase_threshold: +200% 이상 급증
    decrease_threshold: -50% 이상 급감
    """
    # 계정과목 × 월별 합계
    monthly = df.groupby(['계정과목', '월'])['순액'].sum().reset_index()

    # 월 정렬
    monthly = monthly.sort_values(['계정과목', '월'])

    # 전월 대비 증감률
    monthly['전월금액'] = monthly.groupby('계정과목')['순액'].shift(1)
    monthly['증감률'] = (
        (monthly['순액'] - monthly['전월금액']) /
        monthly['전월금액'].replace(0, 1)
    )

    anomalies = []
    for _, row in monthly.iterrows():
        if pd.isna(row['증감률']):
            continue

        flag = None
        if row['증감률'] > increase_threshold:
            flag = '급증'
        elif row['증감률'] < decrease_threshold:
            flag = '급감'
        elif row['전월금액'] > 0 and row['순액'] == 0:
            flag = '거래중단'

        if flag:
            anomalies.append({
                '계정과목': row['계정과목'],
                '월': row['월'],
                '금액': row['순액'],
                '전월금액': row['전월금액'],
                '증감률': round(row['증감률'] * 100, 1),
                '플래그': flag
            })

    return pd.DataFrame(anomalies)
```

### 4. 마이너스 금액 탐지

```python
def detect_negative_amounts(df):
    """
    비정상 음수 금액 탐지

    비용 계정에서 음수 = 환불 등 특이 거래
    """
    # 일반적으로 양수여야 하는 계정에서 음수 찾기
    expense_accounts = df[df['손익분류'].isin(['판관비', '매출원가'])]
    negatives = expense_accounts[expense_accounts['순액'] < 0]

    if len(negatives) > 0:
        return negatives[['계정과목', '거래처명', '월', '순액']].assign(플래그='마이너스')

    return pd.DataFrame()
```

---

## 전체 탐지 함수

```python
def detect_all_anomalies(df):
    """모든 이상 탐지 실행"""

    results = []

    # 1. 금액 이상
    amount_anomalies = detect_amount_anomaly(df)
    results.append(amount_anomalies)

    # 2. 빈도 이상
    freq_anomalies = detect_frequency_anomaly(df)
    results.append(freq_anomalies)

    # 3. 전월 대비
    mom_anomalies = detect_mom_change(df)
    results.append(mom_anomalies)

    # 4. 마이너스
    negative_anomalies = detect_negative_amounts(df)
    results.append(negative_anomalies)

    # 결과 통합
    all_anomalies = pd.concat([r for r in results if len(r) > 0], ignore_index=True)

    return all_anomalies
```

---

## 목표 결과물

```
이상 거래 탐지 결과:

계정과목      거래처       월    금액        평균      Z-score   플래그
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
지급수수료   A회계사      03   50,000,000   12,000,000   +3.2    금액이상
복리후생비   B식당        03   150건        20건         +4.5    빈도이상
의약품비     C제약        03   0            30,000,000   -2.8    거래중단
소모품비     D사무용품    03   -5,000,000   3,000,000     -      마이너스
```

---

## 출력 형식

### Excel (이상거래 시트)

```
계정과목 | 거래처명 | 월 | 금액 | 평균 | Z-score | 플래그
```

### JSON

```json
{
  "이상거래": [
    {
      "계정과목": "지급수수료",
      "거래처명": "A회계사",
      "월": "03",
      "금액": 50000000,
      "평균": 12000000,
      "Z-score": 3.2,
      "플래그": "금액이상"
    },
    ...
  ]
}
```

---

## 임계값 조정

| 파라미터 | 기본값 | 설명 |
|----------|--------|------|
| Z-score threshold | 3.0 | 표준편차 3배 이상 |
| 급증 threshold | +200% | 전월 대비 2배 이상 |
| 급감 threshold | -50% | 전월 대비 절반 이하 |

---

## 주의사항

1. **데이터 부족**: 월별 데이터가 3개월 미만이면 통계 신뢰도 낮음
2. **계절성 미반영**: 단순 Z-score는 계절성 고려 안함
3. **오탐 가능**: 실제 정상 거래도 이상으로 탐지될 수 있음
4. **현재 미구현**: analyze_thej.py에 아직 포함되지 않음
