# 07. 카드미반영 상세 분석

## 개요

분개장에 반영되지 않은 카드 거래 상세 목록

---

## 카드미반영이란?

- **증빙유형 88.5**: 시스템이 예측한 카드미반영 거래
- **의미**: 카드 결제는 있었으나 분개장에 아직 반영되지 않음
- **조치**: 수동으로 계정과목 지정 필요

---

## 대상 데이터

```python
df_card_missing = df[df['증빙유형'] == 88.5].copy()
```

---

## 로직

### Step 1: 필요 컬럼 추출

```python
if len(df_card_missing) > 0:
    card_missing_detail = df_card_missing[[
        '회계일자',
        '거래처명',
        '순액',
        '공제구분',
        '전표상태',
        '계정과목'
    ]].copy()
```

### Step 2: 정렬

```python
card_missing_detail = card_missing_detail.sort_values('회계일자')
```

### Step 3: 요약 통계

```python
missing_summary = {
    "건수": len(card_missing_detail),
    "총금액": card_missing_detail['순액'].sum()
}
```

---

## 목표 결과물

```
카드미반영 거래 (88.5):

회계일자      거래처명              금액      공제구분   전표상태    계정추천
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
20240124    주식회사 아롬에프앤비   34,700     공제      확정제외    미추천
20240121    도쿄닷지               27,800     공제      확정제외    미추천
20240104    쿠마키친봉선점         11,500     공제      확정제외    미추천
...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
합계: 13건, 6,853,360원 → 수동 계정 지정 필요
```

---

## 추가 분석 (선택)

### 거래처별 집계

```python
missing_by_trader = df_card_missing.groupby('거래처명').agg({
    '순액': ['sum', 'count']
}).reset_index()
missing_by_trader.columns = ['거래처명', '금액', '건수']
missing_by_trader = missing_by_trader.sort_values('금액', ascending=False)
```

### 월별 분포

```python
missing_by_month = df_card_missing.groupby('월')['순액'].agg(['sum', 'count'])
missing_by_month.columns = ['금액', '건수']
```

### 전표상태별 분포

```python
missing_by_status = df_card_missing.groupby('전표상태')['순액'].agg(['sum', 'count'])
```

---

## 조건부 필수 컬럼

증빙유형 88.5일 때 추가로 있을 수 있는 컬럼:

| 컬럼 | 설명 |
|------|------|
| 공급가액 | 세전 금액 |
| 부가세 | VAT |
| 총금액 | 공급가액 + 부가세 |
| 카드미반영_예측 | AI 예측 여부 |
| AI추천_차변후보수 | AI 추천 계정 수 |

---

## 출력 형식

### Excel (카드미반영 시트)

```
회계일자 | 거래처명 | 순액 | 공제구분 | 전표상태 | 계정과목
```

### JSON

```json
{
  "카드미반영": [
    {
      "회계일자": "20240124",
      "거래처명": "주식회사 아롬에프앤비",
      "순액": 34700,
      "공제구분": "공제",
      "전표상태": "확정제외",
      "계정과목": null
    },
    ...
  ]
}
```

---

## 콘솔 출력 예시

```python
if len(df_card_missing) > 0:
    print(f"   카드미반영: {len(card_missing_detail)}건, "
          f"총 {card_missing_detail['순액'].sum():,.0f}원")
else:
    print("   카드미반영 없음")
```

---

## 주의사항

1. **데이터 없음**: 카드미반영이 없으면 빈 DataFrame
2. **계정과목 null**: 미추천 거래는 계정과목이 비어있음
3. **수동 처리 필요**: 이 목록의 거래는 담당자가 직접 계정 지정해야 함
