# 06. 카드 현황 분석

## 개요

신용카드 자동전표의 처리 상태 및 공제 현황 분석

---

## 대상 데이터

```python
# 증빙유형 88(카드) 또는 88.5(카드미반영)
df_card = df[df['증빙유형'].isin([88, 88.5])].copy()
```

---

## 관련 코드표

### 전표상태 (ty_jungstat)

| 코드 | 의미 | 분개장 반영 |
|:----:|------|:----------:|
| 1 | 확정가능 | X |
| 2 | 전표확정 | O |
| 3 | 확정제외 | X |
| 4 | 중복전표 | X |
| 5 | 미추천 | X |
| 6 | 삭제전표 | X |

### 공제구분 (ty_gongjea)

| 코드 | 의미 |
|:----:|------|
| 1 | 불공제 |
| 2 | 공제 |

---

## 로직

### Step 1: 결측값 처리

```python
df_card['전표상태'] = df_card['전표상태'].fillna('없음')
df_card['공제구분'] = df_card['공제구분'].fillna('없음')
```

### Step 2: 피벗 테이블 생성

```python
card_status = df_card.pivot_table(
    index='계정과목',
    columns=['공제구분', '전표상태'],
    values='순액',
    aggfunc='sum',
    fill_value=0
)
```

---

## 목표 결과물

```
                        공제                              불공제
                 확정    확정가능  확정제외       확정    확정가능  확정제외
계정과목
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
복리후생비(판)   500,000   50,000   10,000    200,000   30,000    5,000
접대비           100,000   20,000    5,000    300,000   80,000   20,000
차량유지비       200,000   10,000        0    150,000   40,000   10,000
```

---

## 추가 분석 (선택)

### 처리율 계산

```python
def calculate_processing_rate(df_card):
    """
    처리율 = 전표확정(2) / 전체
    """
    total = df_card['순액'].sum()
    confirmed = df_card[df_card['전표상태'] == 2]['순액'].sum()

    return (confirmed / total * 100) if total > 0 else 0

processing_rate = calculate_processing_rate(df_card)
```

### 미처리 금액

```python
# 전표상태가 확정(2)이 아닌 것들
unprocessed = df_card[df_card['전표상태'] != 2]['순액'].sum()
```

### 불공제 비율

```python
# 공제구분 = 1(불공제) 비율
non_deductible = df_card[df_card['공제구분'] == 1]['순액'].sum()
total = df_card['순액'].sum()
non_deductible_rate = (non_deductible / total * 100) if total > 0 else 0
```

---

## 요약 통계

```python
card_summary = {
    "총_카드거래": len(df_card),
    "총_금액": df_card['순액'].sum(),
    "처리율": processing_rate,
    "미처리_금액": unprocessed,
    "불공제_비율": non_deductible_rate
}
```

---

## 출력 형식

### Excel (카드현황 시트)

MultiIndex 열 구조 유지:
- Level 0: 공제구분 (공제, 불공제)
- Level 1: 전표상태 (확정, 확정가능, 확정제외, ...)

### JSON

```json
{
  "카드현황": {
    "피벗": [...],
    "요약": {
      "처리율": 85.0,
      "미처리금액": 230000,
      "불공제비율": 45.0
    }
  }
}
```

---

## 주의사항

1. **결측값 처리**: 전표상태, 공제구분이 null일 수 있음
2. **데이터 없음 처리**: 카드 데이터가 없을 경우 빈 DataFrame 반환
3. **MultiIndex 컬럼**: (공제구분, 전표상태) 2단계 컬럼 구조
