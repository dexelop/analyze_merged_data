# 01. 파생 컬럼 생성

## 개요

원본 데이터에 없지만 분석에 필요한 컬럼을 계산하여 추가

---

## 1. is_vat (VAT 증빙 여부)

### 목적
피벗 테이블의 열 구분용 (분개장(vat) vs 분개장(일반))

### 로직

```python
def get_is_vat(증빙유형: float) -> str:
    """
    VAT 관련 증빙유형인지 판별

    VAT 증빙:
    - 86: 세금계산서
    - 87: 영세율 세금계산서
    - 88: 신용카드
    - 89: 현금영수증

    일반 증빙:
    - 0: 수기입력
    - 1: 현금조정
    - 5: 결산분개
    - 40: 원천세
    - 90: 통장자동
    - 기타
    """
    if 증빙유형 in [86, 87, 88, 89]:
        return "vat"
    return "일반"

df['is_vat'] = df['증빙유형'].apply(get_is_vat)
```

---

## 2. 소스유형 (피벗 열 최종값)

### 목적
기본 피벗의 열 헤더로 사용

### 로직

```python
def get_source_type(row: pd.Series) -> str:
    """
    데이터소스 + is_vat 조합

    결과값:
    - '분개장(vat)': 분개장 데이터 중 VAT 증빙
    - '분개장(일반)': 분개장 데이터 중 일반 증빙
    - '카드미반영': 카드미반영 데이터
    """
    if row['데이터소스'] == '카드미반영':
        return '카드미반영'
    return f"분개장({row['is_vat']})"

df['소스유형'] = df.apply(get_source_type, axis=1)
```

---

## 3. 요일 (패턴 분석용)

### 목적
요일별 거래 패턴 분석

### 로직

```python
# 회계일자를 datetime으로 변환
df['회계일자_dt'] = pd.to_datetime(
    df['회계일자'],
    format='%Y%m%d',
    errors='coerce'
)

# 요일 숫자 (0=월요일, 6=일요일)
df['요일'] = df['회계일자_dt'].dt.dayofweek

# 요일 한글명
df['요일명'] = df['요일'].map({
    0: '월', 1: '화', 2: '수',
    3: '목', 4: '금', 5: '토', 6: '일'
})
```

---

## 4. 금액구간 (분포 분석용)

### 목적
금액대별 거래 분포 분석

### 로직

```python
def get_amount_range(순액: float) -> str:
    """
    금액을 구간으로 분류

    구간:
    - 10만 미만
    - 10~50만
    - 50~100만
    - 100~500만
    - 500만 이상
    """
    abs_amt = abs(순액)
    if abs_amt < 100_000:
        return "10만 미만"
    if abs_amt < 500_000:
        return "10~50만"
    if abs_amt < 1_000_000:
        return "50~100만"
    if abs_amt < 5_000_000:
        return "100~500만"
    return "500만 이상"

df['금액구간'] = df['순액'].apply(get_amount_range)
```

---

## 5. 입력지연일수 (품질 분석용)

### 목적
전표 입력 지연 현황 분석

### 로직

```python
# 입력일시가 있는 경우만
if '입력일시' in df.columns:
    df['입력일시_dt'] = pd.to_datetime(df['입력일시'], errors='coerce')
    df['입력지연일수'] = (df['입력일시_dt'] - df['회계일자_dt']).dt.days
```

---

## 6. 증빙유형명 (가독성용)

### 목적
증빙유형 코드를 사람이 읽기 쉬운 이름으로 변환

### 로직

```python
EVIDENCE_NAMES = {
    0: '수기',
    1: '현금조정',
    5: '결산분개',
    40: '원천세',
    86: '세금계산서',
    87: '영세율',
    88: '카드',
    88.5: '카드미반영',
    89: '현금영수증',
    90: '통장자동'
}

df['증빙유형명'] = df['증빙유형'].map(EVIDENCE_NAMES)
df['증빙유형명'] = df['증빙유형명'].fillna(df['증빙유형'].astype(str))
```

---

## 전체 적용 함수

```python
def add_derived_columns(df: pd.DataFrame) -> pd.DataFrame:
    """모든 파생 컬럼 추가"""

    # 1. is_vat
    df['is_vat'] = df['증빙유형'].apply(get_is_vat)

    # 2. 소스유형
    df['소스유형'] = df.apply(get_source_type, axis=1)

    # 3. 요일
    df['회계일자_dt'] = pd.to_datetime(df['회계일자'], format='%Y%m%d', errors='coerce')
    df['요일'] = df['회계일자_dt'].dt.dayofweek
    df['요일명'] = df['요일'].map({0:'월',1:'화',2:'수',3:'목',4:'금',5:'토',6:'일'})

    # 4. 금액구간
    df['금액구간'] = df['순액'].apply(get_amount_range)

    # 5. 증빙유형명
    df['증빙유형명'] = df['증빙유형'].map(EVIDENCE_NAMES).fillna(df['증빙유형'].astype(str))

    return df
```
