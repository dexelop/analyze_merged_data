# 01. 파생 컬럼 생성

## 개요

원본 데이터에 없지만 분석에 필요한 컬럼을 계산하여 추가

---

## 1. 소스유형 (피벗 열 구분)

### 목적
기본 피벗의 열 헤더로 사용 (분개장(vat) vs 분개장(일반) vs 카드미반영)

### 로직

**전표번호 기준으로 vat/일반 구분:**
- 전표번호 >= 50000: 매입매출장에서 파생된 전표 → `분개장(vat)`
- 전표번호 < 50000: 일반 분개 전표 → `분개장(일반)`
- 데이터소스 = '카드미반영': → `카드미반영`

```python
def get_source_type(row: pd.Series) -> str:
    """
    전표번호 기준으로 소스유형 판별

    결과값:
    - '분개장(vat)': 전표번호 >= 50000 (매입매출장 파생)
    - '분개장(일반)': 전표번호 < 50000 (일반 분개)
    - '카드미반영': 카드미반영 데이터
    """
    if row['데이터소스'] == '카드미반영':
        return '카드미반영'

    # 전표번호를 숫자로 변환
    try:
        slip_no = int(row['전표번호']) if row['전표번호'] else 0
    except (ValueError, TypeError):
        slip_no = 0

    if slip_no >= 50000:
        return '분개장(vat)'
    return '분개장(일반)'

df['소스유형'] = df.apply(get_source_type, axis=1)
```

> **변경 이력** (2026-01-06): 증빙유형 기준에서 전표번호 기준으로 변경

---

## 2. 요일 (패턴 분석용)

### 목적
요일별 거래 패턴 분석

### 로직

```python
# 회계일자를 datetime으로 변환
df['회계일자_dt'] = pd.to_datetime(
    df['회계일자'],
    format='%Y%m%d',
    errors='coerce'
)

# 요일 숫자 (0=월요일, 6=일요일)
df['요일'] = df['회계일자_dt'].dt.dayofweek

# 요일 한글명
df['요일명'] = df['요일'].map({
    0: '월', 1: '화', 2: '수',
    3: '목', 4: '금', 5: '토', 6: '일'
})
```

---

## 3. 금액구간 (분포 분석용)

### 목적
금액대별 거래 분포 분석

### 로직

```python
def get_amount_range(순액: float) -> str:
    """
    금액을 구간으로 분류

    구간:
    - 10만 미만
    - 10~50만
    - 50~100만
    - 100~500만
    - 500만 이상
    """
    abs_amt = abs(순액)
    if abs_amt < 100_000:
        return "10만 미만"
    if abs_amt < 500_000:
        return "10~50만"
    if abs_amt < 1_000_000:
        return "50~100만"
    if abs_amt < 5_000_000:
        return "100~500만"
    return "500만 이상"

df['금액구간'] = df['순액'].apply(get_amount_range)
```

---

## 4. 입력지연일수 (품질 분석용)

### 목적
전표 입력 지연 현황 분석

### 로직

```python
# 입력일시가 있는 경우만
if '입력일시' in df.columns:
    df['입력일시_dt'] = pd.to_datetime(df['입력일시'], errors='coerce')
    df['입력지연일수'] = (df['입력일시_dt'] - df['회계일자_dt']).dt.days
```

---

## 5. 증빙유형명 (가독성용)

### 목적
증빙유형 코드를 사람이 읽기 쉬운 이름으로 변환

### 로직

```python
EVIDENCE_NAMES = {
    0: '수기',
    1: '현금조정',
    5: '결산분개',
    40: '원천세',
    86: '세금계산서',
    87: '영세율',
    88: '카드',
    88.5: '카드미반영',
    89: '현금영수증',
    90: '통장자동'
}

df['증빙유형명'] = df['증빙유형'].map(EVIDENCE_NAMES)
df['증빙유형명'] = df['증빙유형명'].fillna(df['증빙유형'].astype(str))
```

---

## 전체 적용 함수

```python
def add_derived_columns(df: pd.DataFrame) -> pd.DataFrame:
    """모든 파생 컬럼 추가"""

    # 1. 소스유형 (전표번호 기준)
    df['소스유형'] = df.apply(get_source_type, axis=1)

    # 2. 요일
    df['회계일자_dt'] = pd.to_datetime(df['회계일자'], format='%Y%m%d', errors='coerce')
    df['요일'] = df['회계일자_dt'].dt.dayofweek
    df['요일명'] = df['요일'].map({0:'월',1:'화',2:'수',3:'목',4:'금',5:'토',6:'일'})

    # 3. 금액구간
    df['금액구간'] = df['순액'].apply(get_amount_range)

    # 4. 증빙유형명
    df['증빙유형명'] = df['증빙유형'].map(EVIDENCE_NAMES).fillna(df['증빙유형'].astype(str))

    return df
```
